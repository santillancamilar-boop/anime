<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voces del Anime ‚Äî Inicio</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{
      --ink:#111827; --brand:#5b21b6; --muted:#FFFFFF;
      --grad1:#f0abfc; --grad2:#93c5fd; --grad3:#a7f3d0; --page-max:1200px;
    }
    *{box-sizing:border-box} html,body{margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      background:linear-gradient(135deg,#fdf2f8,#eef2ff,#ecfdf5);
      background-attachment:fixed; letter-spacing:.01em;
    }
    .container{max-width:var(--page-max);margin:0 auto;padding:0 16px}
    a{color:#6d28d9;text-decoration:none}

    /* NAV */
    .nav{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.7);backdrop-filter:blur(6px);border-bottom:1px solid #e9d5ff}
    .nav-inner{display:flex;align-items:center;gap:12px;padding:10px 0}
    .brand{font-weight:600;color:#6d28d9}
    .tabs{margin-left:auto;display:flex;gap:12px;flex-wrap:wrap}
    .tab{font-weight:500}
    .tab:hover,.tab:focus-visible{font-weight:600}
    .tab.active{font-weight:800;text-decoration:underline}

    /* HERO */
   .hero{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 0;text-align:center} 
    .hero-logo img{max-width:520px;height:auto;filter:drop-shadow(0 8px 22px rgba(124,58,237,.25))} 
 .lead{margin-top:14px;font-weight:600;font-size:1.2rem;background:linear-gradient(90deg,#7c3aed);-webkit-background-clip:text;background-clip:text;color:transparent}    .hero-logo{ display:flex; flex-direction:column; align-items:center; } .hero-logo img{ display:block; } /* evita espacios raros bajo el <img> */

    /* BLOQUES */
    .section{padding:32px 0}
    .frame{border-radius:18px;padding:1px;background:linear-gradient(135deg,var(--grad1),var(--grad2),var(--grad3));box-shadow:0 10px 24px rgba(0,0,0,.08);max-width:var(--page-max);margin-inline:auto}
    .glass{border-radius:18px;background:rgba(255,255,255,.65);backdrop-filter:blur(10px);padding:24px}
    .title{font-weight:800;color:#4c1d95;margin:0 0 12px;position:relative;padding-bottom:4px}
    .title::after{content:"";position:absolute;left:0;bottom:-2px;height:3px;width:64px;border-radius:999px;background:linear-gradient(90deg,#a78bfa,#93c5fd,#86efac);opacity:.9}
    .muted{color:var(--muted)}

    /* ===== Reproductor pastel (ajustes visuales) ===== */
   .player{
  display:flex; flex-direction:column; gap:12px;
  max-width:var(--page-max);
  margin:0 auto;
  background:transparent; border:none;
}

    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;
      background:rgba(255,255,255,.62);
      color:var(--brand);
      border-radius:14px 14px 0 0;
      border-bottom:1px solid rgba(91,33,182,.12);
      backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
    }
    .player .header .title{
  margin:0;
  font-size:16px;
  font-weight:700;
  color:var(--brand);
}

    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(167,139,250,.22);color:var(--ink);border:1px solid rgba(91,33,182,.12)}

    .stage{position:relative;background:#000;border-radius:0 0 14px 14px;overflow:hidden}
    video{width:100%;height:auto;display:block;background:#000}

    .center-play{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .center-play .btn-big{pointer-events:auto;--size:72px;width:var(--size);height:var(--size);border-radius:999px;border:none;display:grid;place-items:center;font-size:28px;color:white;
      background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45));box-shadow:0 10px 30px rgba(0,0,0,.25)}

    .controls-panel{
      background:#fff;border:1px solid #e9d5ff;border-radius:14px;box-shadow:0 6px 18px rgba(23,15,41,.08);
      overflow:hidden;
    }
    .controls{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:14px 16px;padding:14px 16px 12px;background:#fff}
    .row{display:flex;align-items:center;gap:8px}
    .controls .row:first-child{grid-column:1/-1;justify-content:center}

    .btn{--size:40px;width:var(--size);height:var(--size);display:grid;place-items:center;border-radius:12px;border:1px solid #e9d5ff;
      background:linear-gradient(180deg,#fff,#fafafe);box-shadow:0 6px 16px rgba(23,15,41,.08);cursor:pointer;color:var(--ink)}
    .btn[aria-pressed="true"]{outline:2px solid rgba(167,139,250,.45)}

    .seek{grid-column:1/-1;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px}
    .time{font-variant-numeric:tabular-nums;color:var(--muted);font-size:14px;min-width:70px;text-align:center}
    .range{position:relative;height:22px;display:grid;align-items:center}
    .buffered,.progress{pointer-events:none;position:absolute;left:0;height:4px;border-radius:999px}
    .buffered{width:0%;background:#e9d5ff}.progress{width:0%;background:linear-gradient(90deg,#7c3aed,#60a5fa,#34d399)}
    input[type="range"].slider{-webkit-appearance:none;width:100%;height:4px;background:transparent}
    input[type="range"].slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:white;border:2px solid var(--brand)}

    .vol{width:min(180px,25vw)}
    input[type="range"].vol-slider{-webkit-appearance:none;width:100%;height:4px;background:#efeef8;border-radius:999px}
    input[type="range"].vol-slider::-webkit-slider-thumb{width:14px;height:14px;border-radius:50%;background:var(--brand)}

    .select{padding:8px 10px;border-radius:12px;border:1px solid #e9d5ff;background:linear-gradient(180deg,#fff,#fafafe);color:var(--ink)}
    .foot{color:#6b7280;font-size:13px;padding:10px 16px;border-top:1px solid #e9d5ff;background:#fff}

    .captions{position:absolute;left:0;right:0;bottom:6%;display:flex;flex-direction:column;gap:6px;align-items:center;padding:0 12px;z-index:5}
    .cap-line{max-width:min(86%,900px);color:#111;font-weight:600;line-height:1.35;border-radius:14px;padding:8px 12px;box-shadow:0 6px 20px rgba(0,0,0,.16)}
    .track-ja{background:rgba(167,243,208,.95)} .track-romaji{background:rgba(240,171,252,.95)} .track-es{background:rgba(147,197,253,.95)} .track-en{background:rgba(216,180,254,.95)}

    
    /* FOOTER */
    .footer{margin-top:36px;border-top:1px solid #e9d5ff;background:rgba(255,255,255,.65)}
    .footer-inner{
      display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      padding:20px 0;color:#374151;max-width:var(--page-max);margin-inline:auto;
    }
    .footer .title{font-weight:800;color:#5b21b6;margin-bottom:6px}
    ul{margin:0;padding-left:18px}

    /* ‚Äî‚Äî‚Äî Ajustes solicitados ‚Äî‚Äî‚Äî */
    #about-title::after{width:100% !important; left:0; right:0}
    #about-copy{ color:#7c3aed; }

    .functions-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      margin-top:22px;
    }
    .card{border:1px solid #e9d5ff;border-radius:12px;background:rgba(255,255,255,.92);box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .card-inner{padding:12px 14px}
    .card .title{color:#5b21b6}
/* Hover lift para las tarjetas */
.functions-grid .card{
  transition:
    transform .25s cubic-bezier(.22,1,.36,1),
    box-shadow .25s,
    border-color .25s;
  will-change: transform;
}

.functions-grid .card:hover,
.functions-grid .card:focus-within{
  transform: translateY(-6px);
  box-shadow: 0 16px 32px rgba(23,15,41,.14), 0 4px 10px rgba(23,15,41,.06);
  border-color: #d8b4fe; /* lila suave */
}

/* Feedback al hacer click/press */
.functions-grid .card:active{
  transform: translateY(-2px);
}

/* (opcional) solo en dispositivos con hover real */
@media (hover: hover) and (pointer: fine){
  .functions-grid .card:hover,
  .functions-grid .card:focus-within{ transform: translateY(-6px); }
}

/* (opcional) accesible: foco visible si la card es focusable */
.functions-grid .card:focus-visible{
  outline: 2px solid #d8b4fe;
  outline-offset: 2px;
}

/* (opcional) cambia el color del t√≠tulo al hover para m√°s ‚Äúvida‚Äù */
.functions-grid .card:hover .title{ color:#6d28d9; }

    /* === Extensiones para funciones avanzadas (siempre activas) === */
    .tools{ display:flex; gap:8px; padding:10px 16px 0; flex-wrap:wrap }
    .tools .btn{ height:auto; padding:8px 12px; width:auto }
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid #e9d5ff; background:rgba(255,255,255,.92); white-space:nowrap }

    .popover{
  position:fixed;           /* <- clave: ya no se recorta por overflow */
  z-index:9999;
  min-width:220px; max-width:320px;
  background:#fff;
  border:1px solid #e9d5ff;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  padding:10px 12px;
  display:none;
}
.popover .word{ font-weight:800 }
.popover .hint{ color:var(--muted); font-size:12px }
.popover .meaning{ margin-top:6px }


    .word-ja{ cursor:pointer; padding:0 2px; border-radius:6px }
    .word-ja:hover{ background:rgba(0,0,0,.06) }
    .track-romaji .word-ro{ pointer-events:none; cursor:default; padding:0 2px; border-radius:6px }
    .hl { outline:2px solid rgba(167,139,250,.45); background:rgba(167,139,250,.12); border-radius:6px }
    ruby{ ruby-position:over; } rt{ font-size:.65em; color:#6b7280 }

    @media (max-width:600px){
      .header{padding:12px}
      .controls{gap:10px 12px;padding:12px}
      .time{min-width:58px;font-size:13px}
    }
          .tools{ display:none !important; }

 /* ‚Äî‚Äî Paleta suave celeste + acentos lila ‚Äî‚Äî */
.player .header{
  background: #FFFFFF;      /* glass celeste */
  border-bottom: 1px solid #D8E6FF;
}

.player .controls,
.player .foot{
  background:#F6FAFF;                      /* superficie casi blanca */
  border: 1px solid #D8E6FF;
}

/* Botones/select: blanco ‚Üí celeste muy leve */
.player .btn,
.player .select{
  background: linear-gradient(180deg,#FFFFFF,#EFF5FF);
  border-color:#D8E6FF;
  box-shadow: 0 6px 16px rgba(23,15,41,.06);
}

/* Acento lila discreto en ‚Äúactivo/pressed‚Äù y badge */
.player .btn[aria-pressed="true"]{ outline:2px solid #EFD9FF; }
.badge{ background:#F4E9FF; border-color:#EFD9FF; }

/* Sliders */
input[type="range"].vol-slider{ background:#E4EEFF; }  /* pista volumen */
.buffered{ background:#FFFFFF; }                       /* <- aqu√≠ iba # */
.progress{ background:linear-gradient(90deg,#7c3aed,#60A5FA,#34D399); }

/* Popover */
.player .popover{
  background:#FFFFFF;
  border-color:#D8E6FF;
}

/* (opcional) hover/focus un poco m√°s marcado */
.player .btn:hover,
.player .select:focus{ box-shadow:0 8px 20px rgba(23,15,41,.10); }

  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html">Voces del Anime</a>
      <div class="tabs">
        <a class="tab active" href="index.html">Inicio</a>
        <a class="tab" href="lengua.html">Lengua</a>
        <a class="tab" href="cultura.html">Cultura</a>
        <a class="tab" href="comunidad.html">Comunidad</a>
        <a class="tab" href="recursos.html">Recursos</a>
      </div>
    </div>
  </div>

  <main class="main">
    <!-- HERO -->
    <section class="hero">
      <div class="hero-logo">
        <img src="logo-voces.png" alt="Voces del Anime" />
        <h2 class="lead">Explor√° el japon√©s desde sus voces: significado, registro y uso.</h2>
      </div>
    </section>

    <!-- BLOQUE INTRO -->
<section class="section" aria-labelledby="intro-title">
  <div class="frame">
    <div class="glass" style="text-align:center; padding:40px 28px">
      <h2 id="intro-title" class="title"
          style="color:#5B21B6; font-size:clamp(26px,4vw,34px); margin-bottom:20px; display:inline-block; position:relative; padding-bottom:6px;">
        Bienvenido
      </h2>

      <!-- Primer texto -->
  <p id="about-copy" class="muted"
         style="max-width:760px; margin:0 auto 16px; font-size:1.1rem; line-height:1.7; text-align:justify;">
        Este prototipo de sitio web propone empezar a aprender japon√©s a partir de escenas de anime, uniendo <strong>audio</strong>,
        <strong>subt√≠tulos</strong> y <strong>diccionario</strong>. La idea es que entiendas qu√© se dice,
        c√≥mo suena y en qu√© contexto se usa, con una interfaz simple y est√©tica relajante.
      </p>

      <!-- Segundo texto (sobre el reproductor) -->
      <p id="about-copy" class="muted"
         style="max-width:760px; margin:0 auto; font-size:1.1rem; line-height:1.7; text-align:justify;">
        Una herramienta interactiva ser√≠a el siguiente reproductor, que permite explorar escenas con subt√≠tulos en
        <strong>japon√©s</strong>, <strong>r≈çmaji</strong>, <strong>espa√±ol</strong> e <strong>ingl√©s</strong>.
        Pod√©s alternar pistas, ajustar velocidad y hacer clic en palabras japonesas para ver su
        <em>lectura</em> y <em>significado</em>.
      </p>
    </div>
  </div>
</section>

    <!-- BLOQUE REPRODUCTOR -->
    <div class="player" id="player" tabindex="0" aria-label="Reproductor de video con subt√≠tulos y panel flotante">
      <div class="header">
        <h1 class="title">Proyecto integral ‚Äî Reproductor</h1>
        <span class="badge" id="badgeDur">00:00</span>
      </div>

      <div class="stage">
        <video id="video" preload="metadata" playsinline webkit-playsinline poster="poster.jpg">
          <source id="src" src="video.mp4" type="video/mp4" />
          <track id="trk-ja" label="Êó•Êú¨Ë™û"   kind="subtitles" srclang="ja"      src="subs-ja.vtt" default />
          <track id="trk-ro" label="R≈çmaji"  kind="subtitles" srclang="ja-Latn" src="subs-ro.vtt" />
          <track id="trk-es" label="Espa√±ol" kind="subtitles" srclang="es"      src="subs-es.vtt" />
          <track id="trk-en" label="Ingl√©s"  kind="subtitles" srclang="en"      src="subs-en.vtt" />
          Tu navegador no soporta la etiqueta <code>video</code>.
        </video>

        <div class="center-play"><button class="btn-big" id="bigPlay" title="Reproducir">‚ñ∂</button></div>

        <div class="captions" id="captions">
          <div class="cap-line track-ja"     id="cap-ja" hidden></div>
          <div class="cap-line track-romaji" id="cap-romaji" hidden></div>
          <div class="cap-line track-es"     id="cap-es" hidden></div>
          <div class="cap-line track-en"     id="cap-en" hidden></div>
        </div>

        <div class="popover" id="popover">
          <div><span class="word" id="pv-word">‚Äî</span></div>
          <div class="hint" id="pv-read">Lectura: ‚Äî</div>
          <div class="meaning" id="pv-meaning">Significado: ‚Äî</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="Controles">
        <div class="row">
          <button class="btn" id="back10" title="Retroceder 10s">‚ü≤</button>
          <button class="btn" id="play"   title="Reproducir/Pausar"><span id="icon-play">‚ñ∂</span></button>
          <button class="btn" id="fwd10"  title="Avanzar 10s">‚ü≥</button>
        </div>
        <div class="row seek" aria-label="Barra de progreso">
          <div class="time" id="currentTime">0:00</div>
          <div class="range">
            <div class="buffered" id="bufferedBar"></div>
            <div class="progress" id="progressBar"></div>
            <input id="seek" class="slider" type="range" min="0" max="1000" step="1" value="0" />
          </div>
          <div class="time" id="duration">0:00</div>
        </div>
        <div class="row">
          <button class="btn" id="mute" title="Silenciar/Activar">üîä</button>
          <div class="vol"><input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" /></div>
        </div>
        <div class="row">
          <select id="speed" class="select" aria-label="Velocidad">
            <option value="0.5">0.5√ó</option>
            <option value="0.75">0.75√ó</option>
            <option value="1" selected>1√ó</option>
            <option value="1.25">1.25√ó</option>
            <option value="1.5">1.5√ó</option>
            <option value="1.75">1.75√ó</option>
            <option value="2">2√ó</option>
          </select>
          <button class="btn" id="tog-ja"      aria-pressed="true"  title="Alternar Japon√©s">JA</button>
          <button class="btn" id="tog-romaji"  aria-pressed="false" title="Alternar R≈çmaji">RO</button>
          <button class="btn" id="tog-es"      aria-pressed="false" title="Alternar Espa√±ol">ES</button>
          <button class="btn" id="tog-en"      aria-pressed="false" title="Alternar Ingl√©s">EN</button>
          <button class="btn" id="tog-fg"      aria-pressed="false" title="Furigana en JA">FG</button>
          <button class="btn" id="fs"          title="Pantalla completa">‚§¢</button>
        </div>
      </div>  
    </div> 
<!-- BLOQUE: Funciones destacadas -->
<section class="section" aria-labelledby="feat-title">
  <div class="frame">
    <div class="glass" style="padding:24px">
      <h2 id="feat-title" class="title" style="color:#5B21B6">Funciones destacadas</h2>

      <div class="functions-grid">
        <div class="card"><div class="card-inner">
          <div class="title">Subt√≠tulos multiling√ºes</div>
          <p class="muted">
            Altern√° al instante entre <strong>JA</strong> (japon√©s), <strong>RO</strong> (r≈çmaji), <strong>ES (espa√±ol)</strong> e <strong>EN (ingl√©s)</strong> sin recargar el video.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">FG: Furigana</div>
          <p class="muted">
            Activ√° <strong>FG</strong> para mostrar la lectura solo sobre los <em>kanji</em>, facilitando el estudio.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">Diccionario emergente</div>
          <p class="muted">
            Hac√© clic en una palabra (JA o RO) y aparece un panel con <strong>lectura</strong>, <strong>significado</strong> y <strong>nota de uso</strong>.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">Sincron√≠a JA ‚áÑ RO</div>
          <p class="muted">
            Al pasar el mouse o hacer clic, se resalta el segmento equivalente en r≈çmaji y en japon√©s.
          </p>
        </div></div>
      </div>
    </div>
  </div>
</section>
</main>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-inner">
      <div>
        <div class="title">Voces del Anime</div>
        <p>Prototipo conceptual para aprendizaje de lengua y cultura japonesa a trav√©s del anime.</p>
      </div>
      <div>
        <div class="title">Enlaces</div>
        <ul>
          <li><a href="contacto.html">Contacto</a></li>
          <li><a href="creditos.html">Cr√©ditos</a></li>
          <li><a href="politica.html">Pol√≠tica educativa</a></li>
        </ul>
      </div>
      <div>
        <div class="title">Acerca de</div>
        <p>Lengua, cultura y comunidad a trav√©s del anime.</p>
      </div>
    </div>
  </div>

<!-- === Script del reproductor === -->
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const player=$('#player'), video=$('#video'), srcEl=$('#src');

  /* habilitar click en r≈çmaji */
  const roClickCSS = document.createElement('style');
  roClickCSS.textContent = '.track-romaji .word-ro{pointer-events:auto;cursor:pointer}';
  document.head.appendChild(roClickCSS);

  /* === üîß Estilo para subt√≠tulo EN (fix) === */
  const enStyle = document.createElement('style');
  enStyle.textContent = '.track-en{ background:rgba(216,180,254,.95); }';
  document.head.appendChild(enStyle);
  /* === fin fix === */

  const bigPlay=$('#bigPlay'), playBtn=$('#play'), iconPlay=$('#icon-play');
  const back10=$('#back10'), fwd10=$('#fwd10'), seek=$('#seek'),
        progressBar=$('#progressBar'), bufferedBar=$('#bufferedBar');
  const cur=$('#currentTime'), dur=$('#duration'), muteBtn=$('#mute'),
        vol=$('#volume'), speed=$('#speed'), fs=$('#fs'), badgeDur=$('#badgeDur');
  const diag=$('#diag'), statusSrc=$('#statusSrc');
  const pillJA=$('#pillJA'), pillRO=$('#pillRO'), pillES=$('#pillES'), pillEN=$('#pillEN');

  function log(msg){ diag.innerHTML = '['+new Date().toLocaleTimeString()+'] '+msg+'<br>'+diag.innerHTML; }
  function setSrc(url){ srcEl.src=url; statusSrc.textContent='src: '+url; video.load(); }

  function formatTime(s){
    if(!isFinite(s)) return '0:00';
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=String(Math.floor(s%60)).padStart(2,'0');
    return (h>0? h+':'+String(m).padStart(2,'0'):m)+':'+sec;
  }
  video.addEventListener('loadedmetadata',()=>{ dur.textContent=formatTime(video.duration); badgeDur.textContent=formatTime(video.duration); updateBuffered(); });

  function togglePlay(){ (video.paused||video.ended)?video.play():video.pause(); }
  ;[playBtn, video, bigPlay].forEach(el=>el.addEventListener('click', togglePlay));
  video.addEventListener('play', ()=>{ iconPlay.textContent='‚è∏'; bigPlay.style.display='none'; });
  video.addEventListener('pause', ()=>{ iconPlay.textContent='‚ñ∂';  bigPlay.style.display='grid'; });
function placePopoverAtSpan(span){
  const rect = span.getBoundingClientRect();
  const vw = window.innerWidth, vh = window.innerHeight;
  const margin = 8;

  // mostrar y medir
  pop.style.visibility = 'hidden';
  pop.style.display = 'block';
  const pr = pop.getBoundingClientRect();

  // preferir arriba; si no entra, abajo
  let top = rect.top - pr.height - 12;
  if (top < margin) top = rect.bottom + 12;

  // centrar en X y limitar a viewport
  let left = rect.left + (rect.width - pr.width)/2;
  left = Math.max(margin, Math.min(left, vw - pr.width - margin));
  top  = Math.max(margin, Math.min(top , vh - pr.height - margin));

  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';
  pop.style.visibility = 'visible';
}
  back10.addEventListener('click', ()=> video.currentTime=Math.max(0, (video.currentTime||0)-10));
  fwd10 .addEventListener('click', ()=> video.currentTime=Math.min(video.duration||0, (video.currentTime||0)+10));

  function updateTime(){
    cur.textContent=formatTime(video.currentTime);
    progressBar.style.width=((video.currentTime/(video.duration||1))*100)+'%';
    seek.value=Math.round((video.currentTime/(video.duration||1))*1000)||0;
  }
  function updateBuffered(){
    try{
      if(video.buffered && video.buffered.length){
        const end=video.buffered.end(video.buffered.length-1);
        bufferedBar.style.width=((end/(video.duration||1))*100)+'%';
      }
    }catch(e){}
  }
  video.addEventListener('timeupdate', updateTime);
  video.addEventListener('progress', updateBuffered);
  video.addEventListener('loadeddata', updateBuffered);
  seek.addEventListener('input', ()=>{ video.currentTime=(seek.value/1000)*(video.duration||0); updateTime(); });

  function updateMuteIcon(){
    const level=video.muted||video.volume===0?0:video.volume;
    muteBtn.textContent= level===0?'üîá':(level<.5?'üîà':'üîä');
  }
  vol.addEventListener('input', ()=>{ video.volume=Number(vol.value); if(video.volume>0) video.muted=false; updateMuteIcon(); });
  muteBtn.addEventListener('click', ()=>{ video.muted=!video.muted; updateMuteIcon(); });
  video.addEventListener('volumechange', updateMuteIcon); updateMuteIcon();

  speed.addEventListener('change', ()=>{ video.playbackRate=Number(speed.value); });
  function toggleFS(){ if(document.fullscreenElement) document.exitFullscreen(); else player.requestFullscreen().catch(()=>{}); }
  fs.addEventListener('click', toggleFS);

  const capJA=$('#cap-ja'), capRO=$('#cap-romaji'), capES=$('#cap-es'), capEN=$('#cap-en');
  const trkJA=$('#trk-ja'), trkRO=$('#trk-ro'), trkES=$('#trk-es'), trkEN=$('#trk-en');
  const togJA=$('#tog-ja'), togRO=$('#tog-romaji'), togES=$('#tog-es'), togEN=$('#tog-en'), togFG=$('#tog-fg');

  const tracks={ ja:trkJA?.track || null, ro:trkRO?.track || null, es:trkES?.track || null, en:trkEN?.track || null };
  Object.values(tracks).forEach(t=>{ if(t){ try{ t.mode='hidden'; }catch(_){} } });

  function armTrack(el, name, pill){
    if(!el){ if(pill) pill.textContent = name.toUpperCase()+': ‚Äî'; return; }
    const t = el.track;
    function ok(){ if(pill) pill.textContent = `${name.toUpperCase()}: ok (${t.cues?t.cues.length:0})`; renderCue(); }
    function err(){ if(pill) pill.textContent = `${name.toUpperCase()}: error`; }
    if (el.readyState === 2) ok(); else { el.addEventListener('load', ok, {once:true}); el.addEventListener('error', err, {once:true}); }
  }
  armTrack(trkJA,'ja',pillJA); armTrack(trkRO,'ro',pillRO); armTrack(trkES,'es',pillES); armTrack(trkEN,'en',pillEN);

  const state={ showJA:true, showRO:false, showES:false, showEN:false, showFG:false };
  const setToggle=(btn,on)=>btn && btn.setAttribute('aria-pressed', on);
  function syncToggles(){ setToggle(togJA,state.showJA); setToggle(togRO,state.showRO); setToggle(togES,state.showES); setToggle(togEN,state.showEN); setToggle(togFG,state.showFG); }
  function rerenderAndClean(){ renderCue(); clearJAHighlight(); clearROHighlight(); }
  syncToggles();
  togJA && togJA.addEventListener('click', ()=>{ state.showJA=!state.showJA; syncToggles(); rerenderAndClean(); });
  togRO && togRO.addEventListener('click', ()=>{ state.showRO=!state.showRO; syncToggles(); rerenderAndClean(); });
  togES && togES.addEventListener('click', ()=>{ state.showES=!state.showES; syncToggles(); rerenderAndClean(); });
  togEN && togEN.addEventListener('click', ()=>{ state.showEN=!state.showEN; syncToggles(); rerenderAndClean(); });
  togFG && togFG.addEventListener('click', ()=>{ state.showFG=!state.showFG; syncToggles(); renderCue(); });

  /* ======== Diccionario ======== */
const JA_DICT = {
  "Â≠´ÊÇüÈ£Ø": {
    yomi: "„Åù„Çì„Åî„ÅØ„Çì",
    gloss: "Son Gohan (nombre propio)",
    ro: "son gohan",
    forms: ["ÊÇüÈ£Ø (abreviado)", "Â≠´ÊÇüÈ£Ø„Åè„Çì (trato infantil)", "Â≠´ÊÇüÈ£Ø„Åï„Çì (trato neutro)"],
    examples: ["Â≠´ÊÇüÈ£Ø„ÅØÊÇüÁ©∫„ÅÆÊÅØÂ≠ê„Å†„ÄÇ= Son Gohan es el hijo de Gok≈´."]
  },

  "Ê≠£„Åó„ÅÑ": {
    yomi: "„Åü„Å†„Åó„ÅÑ",
    gloss: "correcto; justo",
    ro: "tadashii",
    forms: ["Ê≠£„Åó„Åè (adv.)", "Ê≠£„Åó„Åï (sust.)", "Ê≠£„Åó„Åè„Å™„ÅÑ (neg.)"],
    examples: ["Ê≠£„Åó„ÅÑÁ≠î„Åà„ÇíÈÅ∏„Å∂„ÄÇ= Elegir la respuesta correcta.", "Ê≠£„Åó„ÅèÁîü„Åç„Çã„ÄÇ= Vivir con rectitud."]
  },

  "„Åì„Å®": {
    yomi: "„Åì„Å®",
    gloss: "cosa; hecho; nominalizador",
    ro: "koto",
    forms: ["V-„Åì„Å®„Åå„ÅÇ„Çã (haber hecho/ocurrido)", "V-„Åì„Å®„Å´„Å™„Çã (quedar decidido)", "V-„Åì„Å®„Å´„Åô„Çã (decidir hacer)"],
    examples: ["Êó•Êú¨„Å´Ë°å„Å£„Åü„Åì„Å®„Åå„ÅÇ„Çã„ÄÇ= He estado en Jap√≥n.", "Âá∫Áô∫„ÅØÊòéÊó•„Å®„ÅÑ„ÅÜ„Åì„Å®„Å´„Å™„Å£„Åü„ÄÇ= Se decidi√≥ salir ma√±ana."]
  },

  "„Åü„ÇÅ„Å´": {
    yomi: "„Åü„ÇÅ„Å´",
    gloss: "para; por el bien de / a causa de",
    ro: "tame ni",
    forms: ["N „ÅÆ„Åü„ÇÅ„Å´ (por/para N)", "V-ËæûÊõ∏ÂΩ¢ „Åü„ÇÅ„Å´ (para ~)"],
    examples: ["ÂÅ•Â∫∑„ÅÆ„Åü„ÇÅ„Å´ÈÅãÂãï„Åô„Çã„ÄÇ= Hago ejercicio por mi salud.", "ÂêàÊ†º„Åô„Çã„Åü„ÇÅ„Å´ÂãâÂº∑„Åô„Çã„ÄÇ= Estudio para aprobar."]
  },

  "Êà¶„ÅÜ": {
    yomi: "„Åü„Åü„Åã„ÅÜ",
    gloss: "pelear; luchar",
    ro: "tatakau",
    forms: ["Êà¶„Å£„Å¶ (te-form)", "Êà¶„ÅÑ (sust.)", "Êà¶„Çè„Å™„ÅÑ (neg.)", "Êà¶„Åà„Çã (potencial)"],
    examples: ["Ëá™Áî±„ÅÆ„Åü„ÇÅ„Å´Êà¶„ÅÜ„ÄÇ= Luchar por la libertad.", "ÊúÄÂæå„Åæ„ÅßÊà¶„Å£„Åü„ÄÇ= Luch√≥ hasta el final."]
  },

  "ÁΩ™": {
    yomi: "„Å§„Åø",
    gloss: "pecado; culpa; delito",
    ro: "tsumi",
    forms: ["ÊúâÁΩ™ (culpable)", "ÁÑ°ÁΩ™ (inocente)", "ÁΩ™‰∫∫ (criminal)", "ÁΩ™ÊÇ™ÊÑü (sentimiento de culpa)"],
    examples: ["ÁΩ™„ÇíÁäØ„Åô„ÄÇ= Cometer un delito.", "ÁΩ™ÊÇ™ÊÑü„ÇíÊä±„Åè„ÄÇ= Sentir culpa."]
  },

  "„Åß„ÅØ„Å™„ÅÑ": {
    yomi: "„Åß„ÅØ„Å™„ÅÑ",
    gloss: "no es; negaci√≥n de „Å†",
    ro: "de wa nai",
    forms: ["„Åò„ÇÉ„Å™„ÅÑ (coloquial)", "„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì (formal)"],
    examples: ["„Åù„Çå„ÅØÁúüÂÆü„Åß„ÅØ„Å™„ÅÑ„ÄÇ= Eso no es verdad.", "Â≠¶Áîü„Åò„ÇÉ„Å™„ÅÑ„ÄÇ= No soy estudiante."]
  },

  "Ë©±„ÅóÂêà„ÅÑ": {
    yomi: "„ÅØ„Å™„Åó„ÅÇ„ÅÑ",
    gloss: "di√°logo; discusi√≥n",
    ro: "hanashiai",
    forms: ["Ë©±„ÅóÂêà„ÅÜ (verbo)", "Ë©±„ÅóÂêà„ÅÑ„ÅßËß£Ê±∫„Åô„Çã (resolver por di√°logo)"],
    examples: ["ÂïèÈ°å„ÇíË©±„ÅóÂêà„ÅÑ„ÅßËß£Ê±∫„Åô„Çã„ÄÇ= Resolver un problema mediante di√°logo."]
  },

  "„Å™„Å©": {
    yomi: "„Å™„Å©",
    gloss: "etc.; cosas como ~; y as√≠",
    ro: "nado",
    forms: ["N „Å™„Å© (entre otros)", "N „ÇÑ N „Å™„Å© (N y N, etc.)"],
    examples: ["Êú¨„ÇÑÈõëË™å„Å™„Å©„ÇíË™≠„ÇÄ„ÄÇ= Leer libros, revistas, etc."]
  },

  "ÈÄöÁî®„Åó„Å™„ÅÑ": {
    yomi: "„Å§„ÅÜ„Çà„ÅÜ„Åó„Å™„ÅÑ",
    gloss: "no funciona; no surte efecto",
    ro: "ts≈´y≈ç shinai",
    rov: ["tsuuyou shinai"],
    forms: ["ÈÄöÁî®„Åô„Çã (funcionar; ser v√°lido)", "ÈÄöÁî®„Åó„Å™„Åã„Å£„Åü (pasado neg.)"],
    examples: ["„Åì„ÅÆÊâã„ÅØÂΩº„Å´„ÅØÈÄöÁî®„Åó„Å™„ÅÑ„ÄÇ= Esta t√°ctica no funciona con √©l."]
  },

  "Áõ∏Êâã": {
    yomi: "„ÅÇ„ÅÑ„Å¶",
    gloss: "oponente; interlocutor; pareja (de juego/conversaci√≥n)",
    ro: "aite",
    forms: ["Ë©±„ÅóÁõ∏Êâã (conversador)", "Áõ∏Êâã„Å´„Åô„Çã (tomar en cuenta/tratar con)"],
    examples: ["Âº∑„ÅÑÁõ∏Êâã„Å†„ÄÇ= Es un oponente fuerte.", "ÂΩº„ÇíÁõ∏Êâã„Å´„Åó„Å™„ÅÑ„ÄÇ= No le des bola."]
  },

  "„ÇÇ„ÅÑ„Çã„ÅÆ„Å†": {
    yomi: "„ÇÇ„ÅÑ„Çã„ÅÆ„Å†",
    gloss: "tambi√©n hay/existen (tono explicativo)",
    ro: "mo iru no da",
    forms: ["„ÇÇ„ÅÑ„Çã„Çì„Å† (coloquial)", "„ÇÇ„ÅÑ„Çã„Çì„Åß„Åô (cort√©s)"],
    examples: ["ÁêÜËß£„Åß„Åç„Å™„ÅÑ‰∫∫„ÇÇ„ÅÑ„Çã„ÅÆ„Å†„ÄÇ= Tambi√©n hay gente que no puede entender."],
    note: "„ÅÆ„Å†/„Çì„Å† a√±ade matiz explicativo o enf√°tico."
  },

  "„ÅÑ„Çã„ÅÆ„Å†": {
    yomi: "„ÅÑ„Çã„ÅÆ„Å†",
    gloss: "hay/est√° (explicativo; seres animados)",
    ro: "iru no da",
    forms: ["„ÅÑ„Çã„Çì„Å† (coloquial)", "„ÅÑ„Çã„Çì„Åß„Åô (cort√©s)"],
    examples: ["„Åì„Åì„Å´Âä©„Åë„Å¶„Åè„Çå„Çã‰∫∫„Åå„ÅÑ„Çã„ÅÆ„Å†„ÄÇ= Aqu√≠ hay alguien que puede ayudar."],
    note: "„ÅÆ„Å†/„Çì„Å† explica, enfatiza o justifica."
  },

  "Á≤æÁ•û": {
    yomi: "„Åõ„ÅÑ„Åó„Çì",
    gloss: "esp√≠ritu; mente; mentalidad",
    ro: "seishin",
    forms: ["Á≤æÁ•ûÁöÑ (mental)", "Á≤æÁ•ûÂäõ (fuerza mental)", "Á≤æÁ•ûÁä∂ÊÖã (estado mental)"],
    examples: ["Á≤æÁ•û„ÇíÈçõ„Åà„Çã„ÄÇ= Fortalecer el esp√≠ritu."]
  },

  "ÂÖâ": {
    yomi: "„Å≤„Åã„Çä",
    gloss: "luz",
    ro: "hikari",
    forms: ["ÂÖâ„Çã (brillar)", "Êó•ÂÖâ (luz solar)", "ÂÖâÊôØ (escena; vista)"],
    examples: ["ÂÖâ„ÅåÂ∑Æ„ÅóËæº„ÇÄ„ÄÇ= Entra la luz."]
  },

  "„Åæ„Åæ": {
    yomi: "„Åæ„Åæ",
    gloss: "tal cual; manteniendo el estado",
    ro: "mama",
    forms: ["N „ÅÆ„Åæ„Åæ (tal como N)", "V-„Åü „Åæ„Åæ (quedarse tras V)", "V-„Å™„ÅÑ „Åæ„Åæ (sin V)"],
    examples: ["Èù¥„ÅÆ„Åæ„ÅæÂÖ•„Çâ„Å™„ÅÑ„Åß„ÄÇ= No entres con zapatos.", "ÈõªÊ∞ó„Çí„Å§„Åë„Åü„Åæ„ÅæÂØù„Åü„ÄÇ= Dorm√≠ con la luz encendida."],
    note: "X „ÅÆ„Åæ„Åæ = 'tal como X'. Mantiene estado/situaci√≥n."
  },

  "Ëá™Áî±„Å´": {
    yomi: "„Åò„ÇÜ„ÅÜ„Å´",
    gloss: "libremente",
    ro: "jiy≈´ ni",
    rov: ["jiyuu ni"],
    forms: ["Ëá™Áî± (sust.)", "Ëá™Áî±„Å™ (adj.)"],
    examples: ["Ëá™Áî±„Å´ÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ= Elija libremente."]
  },

  "Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå": {
    yomi: "„Åã„ÅÑ„Åª„ÅÜ„Åó„Å¶„ÇÑ„Çå",
    gloss: "¬°lib√©ralo! (benefactivo, tono imperativo)",
    ro: "kaih≈ç shite yare",
    rov: ["kaihou shite yare"],
    forms: ["Ëß£Êîæ„Åô„Çã (liberar)", "„Äú„Åó„Å¶„ÇÑ„Çã (hacer por alguien; benefactivo ‚Äòyo‚Üívos/√©l‚Äô)"],
    examples: ["Á≤æÁ•û„ÇíÂÖâ„ÅÆ„Åæ„ÅæËá™Áî±„Å´Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå„ÄÇ= Libera el esp√≠ritu tal como luz, libremente."],
    note: "„Åó„Å¶„ÇÑ„Çã: ‚Äòhacerle un favor‚Äô a alguien de estatus similar/inferior; tono cercano."
  },

  "Ê∞óÊåÅ„Å°": {
    yomi: "„Åç„ÇÇ„Å°",
    gloss: "sentimiento; sensaci√≥n; √°nimo",
    ro: "kimochi",
    forms: ["Ê∞óÊåÅ„Å°„ÅÑ„ÅÑ (agradable)", "Ê∞óÊåÅ„Å°ÊÇ™„ÅÑ (asqueroso/malestar)", "„ÅÑ„ÅÑÊ∞óÊåÅ„Å° (buen √°nimo)", "Ê∞óÊåÅ„Å°„Å´„Å™„Çã (sentirse ~)"],
    examples: ["Ê∞óÊåÅ„Å°„ÅåÂàÜ„Åã„Çã„ÄÇ= Entiendo c√≥mo te sent√≠s.", "Ê∞óÊåÅ„Å°„ÅÑ„ÅÑÈ¢®„Å†„ÄÇ= Es un viento agradable."]
  },
  "ÂàÜ„Åã„Çã": {
    yomi: "„Çè„Åã„Çã",
    gloss: "entender; comprender",
    ro: "wakaru",
    forms: ["ÂàÜ„Åã„Å£„Åü (pasado)", "ÂàÜ„Åã„Çâ„Å™„ÅÑ (neg.)", "ÂàÜ„Åã„Çä„ÇÑ„Åô„ÅÑ (f√°cil de entender)", "ÂàÜ„Åã„Çä„Å´„Åè„ÅÑ (dif√≠cil de entender)"],
    examples: ["Â∞ë„ÅóÊó•Êú¨Ë™û„ÅåÂàÜ„Åã„Çã„ÄÇ= Entiendo un poco de japon√©s.", "ÊÑèÂë≥„ÅåÂàÜ„Åã„Çâ„Å™„ÅÑ„ÄÇ= No entiendo el significado."]
  },
  "„ÇÇ„ÅÜ": {
    yomi: "„ÇÇ„ÅÜ",
    gloss: "ya; m√°s; (frustraci√≥n) ‚Äò¬°basta!‚Äô",
    ro: "m≈ç",
    rov: ["mou"],
    forms: ["„ÇÇ„ÅÜ„Åô„Åê (muy pronto)", "„ÇÇ„ÅÜ‰∏ÄÂ∫¶ (una vez m√°s)", "„ÇÇ„ÅÜ„Äú„Å™„ÅÑ (ya no)"],
    examples: ["„ÇÇ„ÅÜÊàëÊÖ¢„Åß„Åç„Å™„ÅÑ„ÄÇ= Ya no puedo aguantar.", "„ÇÇ„ÅÜ„Åô„ÅêÂßã„Åæ„Çã„ÄÇ= Ya empieza."]
  },
  "ÊàëÊÖ¢„Åô„Çã": {
    yomi: "„Åå„Åæ„Çì„Åô„Çã",
    gloss: "aguantarse; soportar; contenerse",
    ro: "gaman suru",
    forms: ["ÊàëÊÖ¢„Åß„Åç„Çã/„Åß„Åç„Å™„ÅÑ (poder/no poder soportar)", "ÊàëÊÖ¢Âº∑„ÅÑ (paciente)"],
    examples: ["Áóõ„Åø„ÇíÊàëÊÖ¢„Åô„Çã„ÄÇ= Soportar el dolor.", "ÂΩº„ÅØÊàëÊÖ¢Âº∑„ÅÑ„ÄÇ= Es muy paciente."]
  },
  "„Åì„Å®„ÅØ„Å™„ÅÑ": {
    yomi: "„Åì„Å®„ÅØ„Å™„ÅÑ",
    gloss: "no hace falta; no es necesario / no necesariamente",
    ro: "koto wa nai",
    forms: ["V(ËæûÊõ∏ÂΩ¢)+„Åì„Å®„ÅØ„Å™„ÅÑ (no es necesario V)", "ÂøÖ„Åö„Åó„ÇÇ„Äú„Å®„ÅÑ„ÅÜ„Åì„Å®„ÅØ„Å™„ÅÑ (no necesariamente)"],
    examples: ["ÂøÉÈÖç„Åô„Çã„Åì„Å®„ÅØ„Å™„ÅÑ„ÄÇ= No hace falta preocuparse.", "È´ò„ÅÑ„Åã„Çâ„Å®„ÅÑ„Å£„Å¶ËâØ„ÅÑ„Å®„ÅÑ„ÅÜ„Åì„Å®„ÅØ„Å™„ÅÑ„ÄÇ= Que sea caro no significa que sea bueno."]
  },
  "„ÅÆ„Åå": {
    yomi: "„ÅÆ„Åå",
    gloss: "(nominalizador + „Åå: ‚Äòel hecho de ~‚Äô como sujeto)",
    ro: "no ga",
    forms: ["V(ËæûÊõ∏ÂΩ¢) „ÅÆ„Åå„Äú (me/te/le ~ el hecho de V)", "Adj-„ÅÑ „ÅÆ„Åå„Äú"],
    examples: ["Ëµ∞„Çã„ÅÆ„ÅåÂ•Ω„Åç„Å†„ÄÇ= Me gusta correr.", "Êó©Ëµ∑„Åç„Åô„Çã„ÅÆ„ÅåËã¶Êâã„Å†„ÄÇ= Se me da mal madrugar."]
  },

  // === Part√≠culas ===
  "„Çí": {
    yomi: "„Çí",
    gloss: "marca de objeto directo; tambi√©n ruta/espacio atravesado",
    ro: "o",
    rov: ["wo"],
    forms: ["ÁõÆÁöÑË™û: Ê∞¥„ÇíÈ£≤„ÇÄ", "ÁµåË∑Ø: Ê©ã„ÇíÊ∏°„Çã", "Ëµ∑ÁÇπ„ÅÆÈõ¢ËÑ±: ÂÆ∂„ÇíÂá∫„Çã"],
    examples: ["„Éë„É≥„ÇíÈ£ü„Åπ„Çã„ÄÇ= Comer pan.", "ÈÅì„ÇíÊ≠©„Åè„ÄÇ= Caminar por la calle."]
  },
  "„ÅØ": {
    yomi: "„ÅØ",
    gloss: "tema; contraste",
    ro: "wa",
    forms: ["‰∏ªÈ°åÊèêÁ§∫: ÁßÅ„ÅØ„Äú", "ÂØæÊØî: A„ÅØ„Äú„Åå„ÄÅB„ÅØ„Äú", "Âèñ„ÇäÁ´ã„Å¶Âº∑Ë™ø: ‰ªäÊó•„ÅØÊöë„ÅÑ"],
    examples: ["ÁßÅ„ÅØÂ≠¶Áîü„Åß„Åô„ÄÇ= Yo soy estudiante.", "Áä¨„ÅØÂ•Ω„Åç„Å†„Åå„ÄÅÁå´„ÅØËã¶Êâã„Å†„ÄÇ= Me gustan los perros, pero los gatos no tanto."]
  },
  "„Åå": {
    yomi: "„Åå",
    gloss: "sujeto; √©nfasis; existencia",
    ro: "ga",
    forms: ["Êñ∞ÊÉÖÂ†±ÊèêÁ§∫", "Â≠òÂú®: Â∫≠„Å´Áå´„Åå„ÅÑ„Çã", "ÈÄÜÊé•(„Äú„Åå„ÄÅ): ‚Äòpero‚Äô (m√°s escrito)"],
    examples: ["Èõ®„ÅåÈôç„Å£„Å¶„ÅÑ„Çã„ÄÇ= Est√° lloviendo.", "ÂïèÈ°å„Åå„ÅÇ„Çã„ÄÇ= Hay un problema."]
  },
  "„Å´": {
    yomi: "„Å´",
    gloss: "tiempo; destino; punto; receptor; prop√≥sito",
    ro: "ni",
    forms: ["ÊôÇÈñìÁÇπ: 3ÊôÇ„Å´", "Âà∞ÁùÄ/Â≠òÂú®: Â≠¶Ê†°„Å´Ë°å„Åè / „ÅÑ„Åô„Å´Â∫ß„Çã", "Âèó„ÅëÊâã: ÂΩº„Å´„ÅÇ„Åí„Çã", "ÁõÆÁöÑ: ÂãâÂº∑„Åó„Å´Ë°å„Åè"],
    examples: ["ÔºóÊôÇ„Å´Ëµ∑„Åç„Çã„ÄÇ= Me levanto a las 7.", "Âèã„Å†„Å°„Å´ÊâãÁ¥ô„ÇíÂá∫„Åô„ÄÇ= Enviar una carta a un amigo."]
  },
  "„Åß": {
    yomi: "„Åß",
    gloss: "lugar de acci√≥n; medio; causa; material",
    ro: "de",
    forms: ["Â†¥ÊâÄ: Â≠¶Ê†°„Åß", "ÊâãÊÆµ: „Éê„Çπ„ÅßË°å„Åè", "ÊùêÊñô/ÁØÑÂõ≤: Êú®„Åß‰Ωú„Çã / Êó•Êú¨„Åß‰∏ÄÁï™", "ÂéüÂõ†: Âú∞Èúá„ÅßÂÆ∂„ÅåÂ£ä„Çå„Åü"],
    examples: ["Âõ≥Êõ∏È§®„ÅßË™≠„ÇÄ„ÄÇ= Leer en la biblioteca.", "ÁÆ∏„ÅßÈ£ü„Åπ„Çã„ÄÇ= Comer con palitos."]
  },
  "„Å®": {
    yomi: "„Å®",
    gloss: "y; con; cita textual; condici√≥n natural (‚Äòsi/cuando‚Äô)",
    ro: "to",
    forms: ["‰∏¶Âàó: A„Å®B", "ÂÖ±Âêå: ÂΩº„Å®Ë°å„Åè", "ÂºïÁî®: „Äú„Å®Ë®Ä„ÅÜ", "Á¢∫ÂÆöÊù°‰ª∂: Êò•„Å´„Å™„Çã„Å®Êöñ„Åã„ÅÑ"],
    examples: ["ÂÆ∂Êóè„Å®‰Ωè„ÇÄ„ÄÇ= Vivo con mi familia.", "„ÄéË°å„Åè„Äè„Å®Ë®Ä„Å£„Åü„ÄÇ= Dijo ‚Äòvoy‚Äô.", "„Éú„Çø„É≥„ÇíÊäº„Åô„Å®Èñã„Åè„ÄÇ= Si/Al apretar el bot√≥n, se abre."]
  },
  "„ÇÇ": {
    yomi: "„ÇÇ",
    gloss: "tambi√©n; incluso",
    ro: "mo",
    forms: ["ËøΩÂä†: ÁßÅ„ÇÇ", "Âº∑Ë™ø: ‰∏ÄÂàÜ„ÇÇ„Å™„ÅÑ (ni un minuto)", "‰∏¶ÂàóÂº∑Ë™ø: A„ÇÇB„ÇÇ"],
    examples: ["ÁßÅ„ÇÇË°å„Åè„ÄÇ= Yo tambi√©n voy.", "‰∏ÄÂÜÜ„ÇÇ„Å™„ÅÑ„ÄÇ= No tengo ni un yen."]
  },
  "„ÅÆ": {
    yomi: "„ÅÆ",
    gloss: "posesivo; nominalizador; explicativo (coloquial con „Çì„Å†)",
    ro: "no",
    forms: ["ÈÄ£‰Ωì‰øÆÈ£æ: ÁßÅ„ÅÆÊú¨", "ÂêçË©ûÂåñ: Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åô„Çã„ÅÆ„ÅåÂ•Ω„Åç", "Ë™¨Êòé: „Äú„ÅÆÔºü / „Äú„Çì„Å†"],
    examples: ["ÂΩº„ÅÆËªä„ÄÇ= Su auto.", "Ê≠å„ÅÜ„ÅÆ„ÅåÂ•Ω„Åç„Å†„ÄÇ= Me gusta cantar."]
  },
  "„Å∏": {
    yomi: "„Å∏",
    gloss: "hacia (direcci√≥n, m√°s suave que „Å´)",
    ro: "e",
    forms: ["ÊñπÂêë: Êù±‰∫¨„Å∏Ë°å„Åè", "ÂÆõÂêç: Áî∞‰∏≠„Åï„Çì„Å∏ (en cartas)"],
    examples: ["Â≠¶Ê†°„Å∏ÊÄ•„Åê„ÄÇ= Apurarse hacia la escuela."]
  },
  "„Åã„Çâ": {
    yomi: "„Åã„Çâ",
    gloss: "desde; porque",
    ro: "kara",
    forms: ["Ëµ∑ÁÇπ: 9ÊôÇ„Åã„Çâ", "ÊùêÊñô/ÊÉÖÂ†±Ê∫ê: Âèã„Å†„Å°„Åã„ÇâËÅû„ÅÑ„Åü", "ÁêÜÁî±: ÂØí„ÅÑ„Åã„ÇâÂ∏∞„Çã"],
    examples: ["ÂÆ∂„Åã„ÇâÈßÖ„Åæ„ÅßÊ≠©„Åè„ÄÇ= Camino desde casa hasta la estaci√≥n.", "Èõ®„Å†„Åã„ÇâË°å„Åã„Å™„ÅÑ„ÄÇ= No voy porque llueve."]
  },
  "„Åæ„Åß": {
    yomi: "„Åæ„Åß",
    gloss: "hasta; incluso (√©nfasis)",
    ro: "made",
    forms: ["ÁµÇÁÇπ: „Äú„Åæ„Åß", "ÁØÑÂõ≤Âº∑Ë™ø: Â≠ê„Å©„ÇÇ„Åæ„ÅßÁü•„Å£„Å¶„ÅÑ„Çã (hasta los ni√±os)"],
    examples: ["‰∏âÊôÇ„Åæ„ÅßÂãâÂº∑„Åô„Çã„ÄÇ= Estudio hasta las 3.", "ÂΩº„ÅØÊ≥£„Åè„Åæ„ÅßÁ¨ë„Å£„Åü„ÄÇ= Se ri√≥ hasta llorar."]
  },
  "„Çà„Çä": {
    yomi: "„Çà„Çä",
    gloss: "comparativo (‚Äòm√°s que‚Äô); origen formal",
    ro: "yori",
    forms: ["ÊØîËºÉ: A„Çà„ÇäB„ÅÆ„Åª„ÅÜ„Åå„Äú", "Ëµ∑ÁÇπ(Êõ∏„ÅçË®ÄËëâ): „Åì„Çå„Çà„ÇäÂßã„Åæ„Çã (a partir de ahora)"],
    examples: ["Êò®Êó•„Çà„ÇäÊöñ„Åã„ÅÑ„ÄÇ= M√°s c√°lido que ayer.", "„Åì„Çå„Çà„Çä‰ºöË≠∞„ÇíÂßã„ÇÅ„Åæ„Åô„ÄÇ= A partir de ahora iniciamos la reuni√≥n (formal)."]
  }
};

  const DICT_KEYS=Object.keys(JA_DICT).sort((a,b)=>b.length-a.length);

  // Segmentaci√≥n JA priorizando diccionario
  const segJA = (typeof Intl!=='undefined' && Intl.Segmenter)? new Intl.Segmenter('ja',{granularity:'word'}) : null;
  function sliceWithDict(line){
    const out=[]; let i=0;
    while(i<line.length){
      let m=null;
      for(const k of DICT_KEYS){ if(line.startsWith(k,i)){ m=k; break; } }
      if(m){ const e=JA_DICT[m]; out.push({text:m, dict:e, start:i, end:i+m.length}); i+=m.length; }
      else{ out.push({text:line[i], start:i, end:i+1}); i++; }
    }
    return out;
  }
  function segmentJapanese(line){
    const raw=sliceWithDict(line);
    if(!segJA){ return raw.map(p=> ({text:p.text, start:p.start, end:p.end, dict:p.dict||null})); }
    const out=[]; let buffer='', bStart=null;
    const flush=()=>{
      if(!buffer) return;
      let pos=0;
      for(const it of segJA.segment(buffer)){
        const seg=it.segment;
        const st=bStart + buffer.indexOf(seg,pos);
        const en=st+seg.length;
        pos = buffer.indexOf(seg,pos)+seg.length;
        out.push({text:seg, start:st, end:en, dict:null});
      }
      buffer=''; bStart=null;
    };
    for(const p of raw){
      if(p.dict){ flush(); out.push({text:p.text,start:p.start,end:p.end,dict:p.dict}); }
      else{ if(buffer===''){ buffer=p.text; bStart=p.start; } else buffer+=p.text; }
    }
    flush(); return out;
  }

  /* ======== Romaji helpers ======== */
  const ROMA_MAP = {
    '„Åç„ÇÉ':'kya','„Åç„ÇÖ':'kyu','„Åç„Çá':'kyo','„Åó„ÇÉ':'sha','„Åó„ÇÖ':'shu','„Åó„Çá':'sho','„Å°„ÇÉ':'cha','„Å°„ÇÖ':'chu','„Å°„Çá':'cho',
    '„Å´„ÇÉ':'nya','„Å´„ÇÖ':'nyu','„Å´„Çá':'nyo','„Å≤„ÇÉ':'hya','„Å≤„ÇÖ':'hyu','„Å≤„Çá':'hyo','„Åø„ÇÉ':'mya','„Åø„ÇÖ':'myu','„Åø„Çá':'myo',
    '„Çä„ÇÉ':'rya','„Çä„ÇÖ':'ryu','„Çä„Çá':'ryo','„Åé„ÇÉ':'gya','„Åé„ÇÖ':'gyu','„Åé„Çá':'gyo','„Åò„ÇÉ':'ja','„Åò„ÇÖ':'ju','„Åò„Çá':'jo',
    '„Å≥„ÇÉ':'bya','„Å≥„ÇÖ':'byu','„Å≥„Çá':'byo','„Å¥„ÇÉ':'pya','„Å¥„ÇÖ':'pyu','„Å¥„Çá':'pyo',
    '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko',
    '„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to',
    '„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi','„Åµ':'fu','„Å∏':'he','„Åª':'ho',
    '„Åæ':'ma','„Åø':'mi','„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re','„Çç':'ro',
    '„Çè':'wa','„Çí':'wo','„Çì':'n',
    '„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo',
    '„Å†':'da','„Å¢':'ji','„Å•':'zu','„Åß':'de','„Å©':'do','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Å±':'pa','„Å¥':'pi','„Å∑':'pu','„Å∫':'pe','„ÅΩ':'po',
    '„ÅÅ':'a','„ÅÉ':'i','„ÅÖ':'u','„Åá':'e','„Åâ':'o','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Å£':'','„Éº':''
  };
  function hiraToRoma(str){
    let out=''; for(let i=0;i<str.length;i++){
      const ch=str[i], next=str[i+1]||'';
      if(ch==='„Å£' && next){ const roma = ROMA_MAP[next] || ''; if(roma) out += roma[0]; continue; }
      const dig=str.slice(i,i+2);
      if(ROMA_MAP[dig]){ out+=ROMA_MAP[dig]; i++; continue; }
      out += ROMA_MAP[ch] || ch;
    }
    return out;
  }

  // normalizador macrones ‚Üí secuencias y limpieza
  const norm = (s)=>{
    if(!s) return '';
    const macPre = {'ƒÄ':'aa','ƒÅ':'aa','ƒ™':'ii','ƒ´':'ii','≈™':'uu','≈´':'uu','ƒí':'ee','ƒì':'ee','≈å':'ou','≈ç':'ou'};
    s = s.replace(/[ƒÄƒÅƒ™ƒ´≈™≈´ƒíƒì≈å≈ç]/g, ch => macPre[ch] || ch)
         .replace(/a\u0304/gi,'aa').replace(/i\u0304/gi,'ii')
         .replace(/u\u0304/gi,'uu').replace(/e\u0304/gi,'ee').replace(/o\u0304/gi,'ou');
    return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
  };

  const isKanji = ch => /[\u3400-\u9FFF]/.test(ch);
const isKana  = ch => /[\u3040-\u309F\u30A0-\u30FF„Éº]/.test(ch);
const kataToHira = s => s.replace(/[\u30A1-\u30F6]/g, c => String.fromCharCode(c.charCodeAt(0)-0x60));

function makeRubyKanjiOnly(surface, yomi){
  if(!surface || !yomi) return surface;
  const y = kataToHira(yomi);
  const chars = Array.from(surface);

  // anclamos las s√≠labas que ya vienen en la palabra (kana) dentro de la lectura:
  let p=0;
  const anchors=[]; // [{i: idxSurface, q: idxYomi, len}]
  for(let i=0;i<chars.length;i++){
    const ch = chars[i];
    if(isKana(ch)){
      const h = kataToHira(ch);
      const q = y.indexOf(h, p);
      if(q !== -1){ anchors.push({i, q, len:h.length}); p = q + h.length; }
    }
  }

  let lastY = 0, out = '';
  const findAnchorFrom = (idx) => anchors.find(a => a.i >= idx);

  for(let i=0;i<chars.length;){
    if(isKanji(chars[i])){
      // agrupamos kanji contiguos como un solo <ruby>
      let j=i; while(j<chars.length && isKanji(chars[j])) j++;
      const next = findAnchorFrom(j);
      const endY = next ? next.q : y.length;
      let read = y.slice(lastY, endY);
      const group = chars.slice(i, j).join('');
      out += `<ruby><rb>${group}</rb><rt>${read}</rt></ruby>`;
      lastY = endY;
      i = j;
    }else{
      out += chars[i];
      const a = anchors.find(a => a.i === i);
      if(a) lastY = Math.max(lastY, a.q + a.len);
      i++;
    }
  }
  return out;
}


  /* ======== Render ======== */
 function renderLine(track, el, mode){
  const show = (state.showJA && mode==='ja') ||
               (state.showRO && mode==='ro') ||
               (state.showES && mode==='es') ||
               (state.showEN && mode==='en');
  if(!show){ el.hidden=true; el.innerHTML=''; return; }

  // localizar cue activo
  let cue=null;
  if(track?.activeCues?.length) cue=track.activeCues[0];
  else if(track?.cues?.length){
    const t=video.currentTime;
    for(let i=0;i<track.cues.length;i++){
      const c=track.cues[i];
      if(t>=c.startTime && t<=c.endTime){ cue=c; break; }
    }
  }
  if(!cue){ el.hidden=true; el.innerHTML=''; return; }

  el.hidden=false; el.innerHTML='';
  const lines = cue.text.split(/\r?\n/);

  for(let li=0; li<lines.length; li++){
    const lineText = lines[li];

    if(mode==='ja'){
      const tokens = segmentJapanese(lineText);
      const wrap = document.createElement('span');
      wrap.className = 'line-ja';
      wrap.dataset.text = lineText;

      tokens.forEach((tok, idx) => {
        const sp = document.createElement('span');
        sp.className = 'word-ja';

        // ¬øeste token tiene kanji?
        const hasKanji = Array.from(tok.text).some(isKanji);

        // Furigana solo sobre los kanji si FG est√° activo y hay lectura en el diccionario
        if (state.showFG && tok.dict && hasKanji) {
          sp.innerHTML = makeRubyKanjiOnly(tok.text, tok.dict.yomi);
        } else {
          sp.textContent = tok.text;
        }

        // metadatos
        sp.dataset.word  = tok.text.trim();
        sp.dataset.start = tok.start;
        sp.dataset.end   = tok.end;
        sp.dataset.idx   = idx;

        if (tok.dict) {
          sp.dataset.dict  = '1';
          sp.dataset.yomi  = tok.dict.yomi  || '';
          sp.dataset.gloss = tok.dict.gloss || '';
          if (tok.dict.ro)   sp.dataset.roma = tok.dict.ro;
          if (tok.dict.note) sp.dataset.note = tok.dict.note;
        } else {
          sp.dataset.dict = '0';
        }

        wrap.appendChild(sp);
      });

      el.appendChild(wrap);

    } else if(mode==='ro'){
      const parts = lineText.split(/(\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-])/).filter(Boolean);
      let idx=0;
      parts.forEach(tok=>{
        if(/\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-]/.test(tok)){
          el.appendChild(document.createTextNode(tok));
        }else{
          const sp=document.createElement('span');
          sp.className='word-ro';
          sp.textContent=tok;
          sp.dataset.norm = norm(tok);
          sp.dataset.idx = String(idx++);
          el.appendChild(sp);
        }
      });

    } else {
      el.appendChild(document.createTextNode(lineText));
    }

    if(li<lines.length-1) el.appendChild(document.createElement('br'));
  }
}


  function renderCue(){
    renderLine(tracks.ja,capJA,'ja');
    renderLine(tracks.ro,capRO,'ro');
    renderLine(tracks.es,capES,'es');
    renderLine(tracks.en,capEN,'en');
  }
  Object.values(tracks).forEach(t=>{ t && t.addEventListener('cuechange', renderCue); });
  video.addEventListener('timeupdate', renderCue);
  video.addEventListener('seeked', renderCue);
  video.addEventListener('ratechange', renderCue);
  window.addEventListener('load', renderCue);

  /* ======== Popover + highlight ======== */
  const pop=$('#popover'), pvWord=$('#pv-word'), pvRead=$('#pv-read'), pvMeaning=$('#pv-meaning');

  function longestDictAt(line, pos){
    let best = null;
    for (const k of DICT_KEYS){
      let from = 0, i;
      while ((i = line.indexOf(k, from)) !== -1){
        const j = i + k.length;
        if (i <= pos && pos < j){
          if (!best || k.length > best.text.length){
            best = { text:k, start:i, end:j, entry: JA_DICT[k] };
          }
        }
        from = i + 1;
        if (from >= line.length) break;
      }
    }
    return best;
  }

  // helpers de highlight (una sola vez)
  let roBadgeEl=null;
  function clearROHighlight(){
    capRO.querySelectorAll('.hl').forEach(el=>el.classList.remove('hl'));
    if(roBadgeEl && roBadgeEl.parentNode) roBadgeEl.parentNode.removeChild(roBadgeEl);
    roBadgeEl=null;
  }
  function clearJAHighlight(){ capJA.querySelectorAll('.hl').forEach(el=>el.classList.remove('hl')); }

  // Resaltar en RO a partir de romaji
  function highlightInRO(romaji){
    clearROHighlight();
    if(!state.showRO || !romaji) return;
    const target = norm(romaji);
    const toks = Array.from(capRO.querySelectorAll('.word-ro'));
    const norms = toks.map(t=>t.dataset.norm||'');

    for(let i=0;i<norms.length;i++){
      let cat='';
      for(let j=i;j<norms.length;j++){
        cat += norms[j];
        if(cat===target){
          for(let k=i;k<=j;k++) toks[k].classList.add('hl');
          return;
        }
        if(cat.length >= target.length) break;
      }
    }
    for(let i=0;i<norms.length;i++){ if(norms[i]===target){ toks[i].classList.add('hl'); return; } }
    let pick=-1, bestLen=0;
    for(let i=0;i<norms.length;i++){
      const n=norms[i];
      if(n.includes(target) || target.includes(n)){ if(n.length>bestLen){ pick=i; bestLen=n.length; } }
    }
    if(pick!==-1){ toks[pick].classList.add('hl'); return; }
    roBadgeEl=document.createElement('span'); roBadgeEl.className='ro-badge'; roBadgeEl.textContent=romaji; capRO.appendChild(roBadgeEl);
  }

  /* === HOVER: Japon√©s -> Romaji (si ambos visibles) === */
  capJA.addEventListener('mousemove', (e) => {
    if (!state.showJA) return;

    const jaSpan = e.target.closest('.word-ja');
    clearJAHighlight();

    if (!jaSpan) {
      if (state.showRO) clearROHighlight();
      return;
    }

    jaSpan.classList.add('hl');

    if (!state.showRO) return;

    let romaji = jaSpan.dataset.roma || '';
    let yomi   = jaSpan.dataset.yomi || '';
    const txt  = jaSpan.textContent || '';

    if (!yomi && /[\u3040-\u309F]/.test(txt)) yomi = txt;
    if (!romaji && yomi) romaji = hiraToRoma(yomi);

    if (romaji) highlightInRO(romaji); else clearROHighlight();
  });

  capJA.addEventListener('mouseleave', () => {
    clearJAHighlight();
    if (state.showRO) clearROHighlight();
  });

  /* === HOVER: Romaji -> Japon√©s (si JA visible) === */
  capRO.addEventListener('mousemove', (e)=>{
    if(!state.showRO) return;

    const roSpan = e.target.closest('.word-ro');
    clearROHighlight();

    if(!roSpan){
      if(state.showJA) clearJAHighlight();
      return;
    }

    roSpan.classList.add('hl');

    if(!state.showJA) return;

    const toks = Array.from(capRO.querySelectorAll('.word-ro'));
    const idx  = toks.indexOf(roSpan);
    const get  = i => (i>=0 && i<toks.length)? toks[i].textContent.trim() : null;

    let match=null, entry=null, key=null, win=null;
    outer:
    for (let w=4; w>=1; w--) {
      for (let start=idx-(w-1); start<=idx; start++) {
        if (start<0) continue;
        const parts=[];
        for (let k=0;k<w;k++){ const t=get(start+k); if(!t){ parts.length=0; break; } parts.push(t); }
        if(!parts.length) continue;
        const cand = parts.join(' ');
        for (const k of DICT_KEYS) {
          const e = JA_DICT[k]; if(!e || !e.ro) continue;
          if (norm(e.ro) === norm(cand)) { match=cand; entry=e; key=k; win={start, end:start+w-1}; break outer; }
        }
      }
    }

    if(match){
      for (let i=win.start; i<=win.end; i++) toks[i].classList.add('hl');

      clearJAHighlight();
      let found=false;
      capJA.querySelectorAll('.word-ja').forEach(sp=>{
        if(sp.dataset.word===key){ sp.classList.add('hl'); found=true; }
      });
      if(!found){
        const wrap=capJA.querySelector('.line-ja');
        const line=wrap?(wrap.dataset.text||''):''; const pos=line.indexOf(key);
        if(pos>=0){
          capJA.querySelectorAll('.word-ja').forEach(sp=>{
            const s=Number(sp.dataset.start)||0, en=Number(sp.dataset.end)||0;
            if(s<pos+key.length && en>pos) sp.classList.add('hl');
          });
        } else {
          const byRo = norm(entry.ro);
          capJA.querySelectorAll('.word-ja').forEach(sp=>{
            const r = sp.dataset.roma || (sp.dataset.yomi ? hiraToRoma(sp.dataset.yomi) : '');
            if (r && norm(r) && byRo.includes(norm(r))) sp.classList.add('hl');
          });
        }
      }
    }
  });

  capRO.addEventListener('mouseleave', ()=>{
    clearROHighlight();
    if(state.showJA) clearJAHighlight();
  });

  /* === CLICK EN JAPO: popover + sincroniza RO === */
  document.addEventListener('click',(e)=>{
    if(!state.showJA) return;
    if(!capJA.contains(e.target)) { if(!e.target.closest('#popover')) pop.style.display='none'; return; }

    const span=e.target.closest('.word-ja'); if(!span) return;
    const lineWrap=span.closest('.line-ja');
    const lineText=lineWrap?lineWrap.dataset.text||'':'';
    const start=Number(span.dataset.start)||0, end=Number(span.dataset.end)||start+(span.textContent||'').length;
    const pos=Math.floor((start+end)/2);

    let surface = span.dataset.word || span.textContent;
    let entry = (span.dataset.dict==='1') ? {yomi:span.dataset.yomi,gloss:span.dataset.gloss,ro:span.dataset.roma,note:span.dataset.note} : null;

    if(!entry){
      const best=longestDictAt(lineText, pos);
      if(best){ surface=best.text; entry={yomi:best.entry.yomi,gloss:best.entry.gloss,ro:best.entry.ro,note:best.entry.note}; }
    }

    pvWord.textContent = surface;
    pvRead.textContent = 'Lectura: ' + (entry?.yomi || '‚Äî');
    pvMeaning.textContent = 'Significado: ' + (entry?.gloss || '‚Äî') + (entry?.note ? ' ¬∑ Uso: ' + entry.note : '');

  pop.style.display='block';
requestAnimationFrame(()=> placePopoverAtSpan(span));

    const romaOut = entry?.ro || (entry?.yomi ? hiraToRoma(entry.yomi) : '');
    if(romaOut) highlightInRO(romaOut);
  }, true);

/* === CLICK EN ROMAJI: popover + reflejo JA === */
document.addEventListener('click',(e)=>{
  if(!state.showRO) return;
  if(!capRO.contains(e.target)) return;
  const roSpan = e.target.closest('.word-ro'); if(!roSpan) return;

  const toks = Array.from(capRO.querySelectorAll('.word-ro'));
  const idx  = toks.indexOf(roSpan);
  const get  = i => (i>=0 && i<toks.length)? toks[i].textContent.trim() : null;

  // candidatos de 1 a 4 tokens alrededor del clic
  const candidates = [];
  for (let w=4; w>=1; w--) {
    for (let start=idx-(w-1); start<=idx; start++) {
      if (start<0) continue;
      const parts=[];
      for (let k=0;k<w;k++){ const t=get(start+k); if(!t){ parts.length=0; break; } parts.push(t); }
      if(parts.length) candidates.push({start, end:start+w-1, text:parts.join(' ')});
    }
  }

  // encontrar el candidato que coincide con el diccionario (por r≈çmaji normalizado)
  let match=null, entry=null, key=null;
  const keysWithRO = DICT_KEYS.filter(k => JA_DICT[k]?.ro);
  for (const cand of candidates) {
    const cn = norm(cand.text);
    for (const k of keysWithRO) {
      if (norm(JA_DICT[k].ro) === cn) { match=cand; entry=JA_DICT[k]; key=k; break; }
    }
    if (match) break;
  }
  if(!entry || !match) return;

  // llenar popover
  pvWord.textContent = key;
  pvRead.textContent = 'Lectura: ' + (entry.yomi || '‚Äî');
  pvMeaning.textContent = 'Significado: ' + (entry.gloss || '‚Äî') + (entry.note ? ' ¬∑ Uso: ' + entry.note : '');

  // mostrar popover bien posicionado (usa position:fixed en CSS)
  pop.style.display='block';
  requestAnimationFrame(()=> placePopoverAtSpan(roSpan));

  // highlight correcto en RO
  clearROHighlight();
  for (let i = match.start; i <= match.end; i++) toks[i].classList.add('hl');

  // reflejo en JA si est√° visible
  if (state.showJA) {
    clearJAHighlight();
    const spans = Array.from(capJA.querySelectorAll('.word-ja'));
    const wrap = capJA.querySelector('.line-ja');
    const lineText = wrap ? (wrap.dataset.text || '') : '';
    let jStart = lineText.indexOf(key);
    if (jStart >= 0) {
      spans.forEach(sp=>{
        const s = Number(sp.dataset.start)||0, e2 = Number(sp.dataset.end)||0;
        if (s < jStart + key.length && e2 > jStart) sp.classList.add('hl');
      });
    } else {
      const byRo = norm(entry.ro);
      spans.forEach(sp=>{
        const r = sp.dataset.roma || (sp.dataset.yomi ? hiraToRoma(sp.dataset.yomi) : '');
        if (r && norm(r) && byRo.includes(norm(r))) sp.classList.add('hl');
      });
    }
  }
});


  // limpieza global
  document.addEventListener('mouseleave', ()=>{ clearJAHighlight(); clearROHighlight(); }, true);

  // Herramientas y atajos
  $('#btnTest').addEventListener('click', ()=>{ setSrc('https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'); log('Cargando video de prueba MDN'); });
  $('#btnURL').addEventListener('click', ()=>{ const u=prompt('Peg√° una URL directa a .mp4 (https://...)'); if(!u) return; setSrc(u.trim()); log('Cambi√© src a '+u); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='j' || e.key==='J'){ togJA && togJA.click(); } if(e.key==='a' || e.key==='A'){ togRO && togRO.click(); } if(e.key==='e' || e.key==='E'){ togES && togES.click(); } if(e.key==='n' || e.key==='N'){ togEN && togEN.click(); } if(e.key==='g' || e.key==='G'){ togFG && togFG.click(); } });

  // inicial
  renderCue();
})();
</script>
</body>
</html>
