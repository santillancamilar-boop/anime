<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Voces del Anime ‚Äî Inicio</title>
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    :root{
      --ink:#111827; --brand:#5b21b6; --muted:#6b7280;
      --grad1:#f0abfc; --grad2:#93c5fd; --grad3:#a7f3d0; --page-max:1200px;
    }
    *{box-sizing:border-box} html,body{margin:0}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      color:var(--ink);
      background:linear-gradient(135deg,#fdf2f8,#eef2ff,#ecfdf5);
      background-attachment:fixed; letter-spacing:.01em;
    }
    .container{max-width:var(--page-max);margin:0 auto;padding:0 16px}
    a{color:#6d28d9;text-decoration:none}

    /* NAV */
    .nav{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.7);backdrop-filter:blur(6px);border-bottom:1px solid #e9d5ff}
    .nav-inner{display:flex;align-items:center;gap:12px;padding:10px 0}
    .brand{font-weight:600;color:#6d28d9}
    .tabs{margin-left:auto;display:flex;gap:12px;flex-wrap:wrap}
    .tab{font-weight:500}
    .tab:hover,.tab:focus-visible{font-weight:600}
    .tab.active{font-weight:800;text-decoration:underline}

    /* HERO */
    .hero{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:40px 0;text-align:center}
    .hero-logo img{max-width:520px;height:auto;filter:drop-shadow(0 8px 22px rgba(124,58,237,.25))}
.lead{
  margin-top:14px;
  font-weight:600;
  font-size:1.2rem;
  display:inline-block; /* ‚Üê clave: que no sea block a todo el ancho */
  background-image: linear-gradient(90deg,#7c3aed,#60a5fa);
  background-size:100% 100%;
  background-repeat:no-repeat;
  -webkit-background-clip:text;
  background-clip:text;
  -webkit-text-fill-color:transparent; /* ‚Üê Safari/iOS */
  color:transparent; /* fallback */
}
.hero-logo{ display:flex; flex-direction:column; align-items:center; }
.hero-logo img{ display:block; } /* evita espacios raros bajo el <img> */

    /* BLOQUES */
    .section{padding:32px 0}
    .frame{border-radius:18px;padding:1px;background:linear-gradient(135deg,var(--grad1),var(--grad2),var(--grad3));box-shadow:0 10px 24px rgba(0,0,0,.08);max-width:var(--page-max);margin-inline:auto}
    .glass{border-radius:18px;background:rgba(255,255,255,.65);backdrop-filter:blur(10px);padding:24px}
    .title{font-weight:800;color:#4c1d95;margin:0 0 12px;position:relative;padding-bottom:4px}
    .title::after{content:"";position:absolute;left:0;bottom:-2px;height:3px;width:64px;border-radius:999px;background:linear-gradient(90deg,#a78bfa,#93c5fd,#86efac);opacity:.9}
    .muted{color:var(--muted)}

    /* ===== Reproductor pastel (ajustes visuales) ===== */
   .player{
  display:flex; flex-direction:column; gap:12px;
  max-width:var(--page-max);
  margin:0 auto;
  background:transparent; border:none;
}

    .header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;
      background:rgba(255,255,255,.62);
      color:var(--brand);
      border-radius:14px 14px 0 0;
      border-bottom:1px solid rgba(91,33,182,.12);
      backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);
    }
    .player .header .title{
  margin:0;
  font-size:16px;
  font-weight:700;
  color:var(--brand);
}

    .badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(167,139,250,.22);color:var(--ink);border:1px solid rgba(91,33,182,.12)}

    .stage{position:relative;background:#000;border-radius:0 0 14px 14px;overflow:hidden}
    video{width:100%;height:auto;display:block;background:#000}

    .center-play{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none}
    .center-play .btn-big{pointer-events:auto;--size:72px;width:var(--size);height:var(--size);border-radius:999px;border:none;display:grid;place-items:center;font-size:28px;color:white;
      background:linear-gradient(180deg,rgba(0,0,0,.25),rgba(0,0,0,.45));box-shadow:0 10px 30px rgba(0,0,0,.25)}

    .controls-panel{
      background:#fff;border:1px solid #e9d5ff;border-radius:14px;box-shadow:0 6px 18px rgba(23,15,41,.08);
      overflow:hidden;
    }
    .controls{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:14px 16px;padding:14px 16px 12px;background:#fff}
    .row{display:flex;align-items:center;gap:8px}
    .controls .row:first-child{grid-column:1/-1;justify-content:center}

    .btn{--size:40px;width:var(--size);height:var(--size);display:grid;place-items:center;border-radius:12px;border:1px solid #e9d5ff;
      background:linear-gradient(180deg,#fff,#fafafe);box-shadow:0 6px 16px rgba(23,15,41,.08);cursor:pointer;color:var(--ink)}
    .btn[aria-pressed="true"]{outline:2px solid rgba(167,139,250,.45)}

    .seek{grid-column:1/-1;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px}
    .time{font-variant-numeric:tabular-nums;color:var(--muted);font-size:14px;min-width:70px;text-align:center}
    .range{position:relative;height:22px;display:grid;align-items:center}
    .buffered,.progress{pointer-events:none;position:absolute;left:0;height:4px;border-radius:999px}
    .buffered{width:0%;background:#e9d5ff}.progress{width:0%;background:linear-gradient(90deg,#7c3aed,#60a5fa,#34d399)}
    input[type="range"].slider{-webkit-appearance:none;width:100%;height:4px;background:transparent}
    input[type="range"].slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:white;border:2px solid var(--brand)}

    .vol{width:min(180px,25vw)}
    input[type="range"].vol-slider{-webkit-appearance:none;width:100%;height:4px;background:#efeef8;border-radius:999px}
    input[type="range"].vol-slider::-webkit-slider-thumb{width:14px;height:14px;border-radius:50%;background:var(--brand)}

    .select{padding:8px 10px;border-radius:12px;border:1px solid #e9d5ff;background:linear-gradient(180deg,#fff,#fafafe);color:var(--ink)}
    .foot{color:#6b7280;font-size:13px;padding:10px 16px;border-top:1px solid #e9d5ff;background:#fff}

    .captions{position:absolute;left:0;right:0;bottom:6%;display:flex;flex-direction:column;gap:6px;align-items:center;padding:0 12px;z-index:5}
    .cap-line{max-width:min(86%,900px);color:#111;font-weight:600;line-height:1.35;border-radius:14px;padding:8px 12px;box-shadow:0 6px 20px rgba(0,0,0,.16)}
    .track-ja{background:rgba(167,243,208,.95)} .track-romaji{background:rgba(240,171,252,.95)} .track-es{background:rgba(147,197,253,.95)} .track-en{background:rgba(216,180,254,.95)}

    
    /* FOOTER */
    .footer{margin-top:36px;border-top:1px solid #e9d5ff;background:rgba(255,255,255,.65)}
    .footer-inner{
      display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      padding:20px 0;color:#374151;max-width:var(--page-max);margin-inline:auto;
    }
    .footer .title{font-weight:800;color:#5b21b6;margin-bottom:6px}
    ul{margin:0;padding-left:18px}

    /* ‚Äî‚Äî‚Äî Ajustes solicitados ‚Äî‚Äî‚Äî */
    #about-title::after{width:100% !important; left:0; right:0}
    #about-copy{ color:#374151; }

    .functions-grid{
      display:grid; gap:14px;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      margin-top:22px;
    }
    .card{border:1px solid #e9d5ff;border-radius:12px;background:rgba(255,255,255,.92);box-shadow:0 6px 18px rgba(0,0,0,.06);}
    .card-inner{padding:12px 14px}
    .card .title{color:#5b21b6}

    /* === Extensiones para funciones avanzadas (siempre activas) === */
    .tools{ display:flex; gap:8px; padding:10px 16px 0; flex-wrap:wrap }
    .tools .btn{ height:auto; padding:8px 12px; width:auto }
    .pill{ padding:4px 8px; border-radius:999px; border:1px solid #e9d5ff; background:rgba(255,255,255,.92); white-space:nowrap }

    .popover{
  position:fixed;           /* <- clave: ya no se recorta por overflow */
  z-index:9999;
  min-width:220px; max-width:320px;
  background:#fff;
  border:1px solid #e9d5ff;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  padding:10px 12px;
  display:none;
}
.popover .word{ font-weight:800 }
.popover .hint{ color:var(--muted); font-size:12px }
.popover .meaning{ margin-top:6px }


    .word-ja{ cursor:pointer; padding:0 2px; border-radius:6px }
    .word-ja:hover{ background:rgba(0,0,0,.06) }
    .track-romaji .word-ro{ pointer-events:none; cursor:default; padding:0 2px; border-radius:6px }
    .hl { outline:2px solid rgba(167,139,250,.45); background:rgba(167,139,250,.12); border-radius:6px }
    ruby{ ruby-position:over; } rt{ font-size:.65em; color:#6b7280 }

    @media (max-width:600px){
      .header{padding:12px}
      .controls{gap:10px 12px;padding:12px}
      .time{min-width:58px;font-size:13px}
    }
          .tools{ display:none !important; }

 /* ‚Äî‚Äî Paleta suave celeste + acentos lila ‚Äî‚Äî */
.player .header{
  background: rgba(232,242,255,.72);      /* glass celeste */
  border-bottom: 1px solid #D8E6FF;
}

.player .controls,
.player .foot{
  background:#F6FAFF;                      /* superficie casi blanca */
  border: 1px solid #D8E6FF;
}

/* Botones/select: blanco ‚Üí celeste muy leve */
.player .btn,
.player .select{
  background: linear-gradient(180deg,#FFFFFF,#EFF5FF);
  border-color:#D8E6FF;
  box-shadow: 0 6px 16px rgba(23,15,41,.06);
}

/* Acento lila discreto en ‚Äúactivo/pressed‚Äù y badge */
.player .btn[aria-pressed="true"]{ outline:2px solid #EFD9FF; }
.badge{ background:#F4E9FF; border-color:#EFD9FF; }

/* Sliders */
input[type="range"].vol-slider{ background:#E4EEFF; }  /* pista volumen */
.buffered{ background:#D8E6FF; }                       /* <- aqu√≠ iba # */
.progress{ background:linear-gradient(90deg,#7c3aed,#60A5FA,#34D399); }

/* Popover */
.player .popover{
  background:#FFFFFF;
  border-color:#D8E6FF;
}

/* (opcional) hover/focus un poco m√°s marcado */
.player .btn:hover,
.player .select:focus{ box-shadow:0 8px 20px rgba(23,15,41,.10); }

  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="container nav-inner">
      <a class="brand" href="index.html">Voces del Anime</a>
      <div class="tabs">
        <a class="tab active" href="index.html">Inicio</a>
        <a class="tab" href="lengua.html">Lengua</a>
        <a class="tab" href="cultura.html">Cultura</a>
        <a class="tab" href="comunidad.html">Comunidad</a>
        <a class="tab" href="recursos.html">Recursos</a>
      </div>
    </div>
  </div>

  <main class="main">
    <!-- HERO -->
    <section class="hero">
      <div class="hero-logo">
        <img src="https://i.postimg.cc/LXJ6Nj15/logo-voces.png" alt="Voces del Anime" />
        <h2 class="lead">Explor√° el japon√©s desde sus voces: significado, registro y uso.</h2>
      </div>
    </section>

    <!-- BLOQUE INTRO -->
    <section class="section">
      <div class="frame">
        <div class="glass" style="text-align:center; padding:40px 28px">
          <h2 id="about-title" class="title" style="color:#7c3aed; font-size:clamp(26px,4vw,34px); margin-bottom:20px; display:inline-block; position:relative; padding-bottom:6px;">
            Sobre el reproductor
          </h2>
          <p id="about-copy" class="muted" style="max-width:720px; margin:0 auto; font-size:1.1rem; line-height:1.7; text-align:justify">
            Este reproductor interactivo permite explorar escenas con subt√≠tulos en 
            <strong>japon√©s</strong>, <strong>r≈çmaji</strong>, <strong>espa√±ol</strong> e <strong>ingl√©s</strong>. 
            Pod√©s alternar pistas, ajustar velocidad y hacer clic en palabras japonesas para ver su 
            <em>lectura</em> y <em>significado</em>.
          </p>
        </div>
      </div>
    </section>

    <!-- BLOQUE REPRODUCTOR -->
    <div class="player" id="player" tabindex="0" aria-label="Reproductor de video con subt√≠tulos y panel flotante">
      <div class="header">
        <h1 class="title">Proyecto integral ‚Äî Reproductor</h1>
        <span class="badge" id="badgeDur">00:00</span>
      </div>

      <div class="stage">
        <video id="video" preload="metadata" playsinline webkit-playsinline poster="poster.jpg">
          <source id="src" src="video.mp4" type="video/mp4" />
          <track id="trk-ja" label="Êó•Êú¨Ë™û"   kind="subtitles" srclang="ja"      src="subs-ja.vtt" default />
          <track id="trk-ro" label="R≈çmaji"  kind="subtitles" srclang="ja-Latn" src="subs-ro.vtt" />
          <track id="trk-es" label="Espa√±ol" kind="subtitles" srclang="es"      src="subs-es.vtt" />
          <track id="trk-en" label="Ingl√©s"  kind="subtitles" srclang="en"      src="subs-en.vtt" />
          Tu navegador no soporta la etiqueta <code>video</code>.
        </video>

        <div class="center-play"><button class="btn-big" id="bigPlay" title="Reproducir">‚ñ∂</button></div>

        <div class="captions" id="captions">
          <div class="cap-line track-ja"     id="cap-ja" hidden></div>
          <div class="cap-line track-romaji" id="cap-romaji" hidden></div>
          <div class="cap-line track-es"     id="cap-es" hidden></div>
          <div class="cap-line track-en"     id="cap-en" hidden></div>
        </div>

        <div class="popover" id="popover">
          <div><span class="word" id="pv-word">‚Äî</span></div>
          <div class="hint" id="pv-read">Lectura: ‚Äî</div>
          <div class="meaning" id="pv-meaning">Significado: ‚Äî</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="Controles">
        <div class="row">
          <button class="btn" id="back10" title="Retroceder 10s">‚ü≤</button>
          <button class="btn" id="play"   title="Reproducir/Pausar"><span id="icon-play">‚ñ∂</span></button>
          <button class="btn" id="fwd10"  title="Avanzar 10s">‚ü≥</button>
        </div>
        <div class="row seek" aria-label="Barra de progreso">
          <div class="time" id="currentTime">0:00</div>
          <div class="range">
            <div class="buffered" id="bufferedBar"></div>
            <div class="progress" id="progressBar"></div>
            <input id="seek" class="slider" type="range" min="0" max="1000" step="1" value="0" />
          </div>
          <div class="time" id="duration">0:00</div>
        </div>
        <div class="row">
          <button class="btn" id="mute" title="Silenciar/Activar">üîä</button>
          <div class="vol"><input id="volume" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" /></div>
        </div>
        <div class="row">
          <select id="speed" class="select" aria-label="Velocidad">
            <option value="0.5">0.5√ó</option>
            <option value="0.75">0.75√ó</option>
            <option value="1" selected>1√ó</option>
            <option value="1.25">1.25√ó</option>
            <option value="1.5">1.5√ó</option>
            <option value="1.75">1.75√ó</option>
            <option value="2">2√ó</option>
          </select>
          <button class="btn" id="tog-ja"      aria-pressed="true"  title="Alternar Japon√©s">JA</button>
          <button class="btn" id="tog-romaji"  aria-pressed="false" title="Alternar R≈çmaji">RO</button>
          <button class="btn" id="tog-es"      aria-pressed="false" title="Alternar Espa√±ol">ES</button>
          <button class="btn" id="tog-en"      aria-pressed="false" title="Alternar Ingl√©s">EN</button>
          <button class="btn" id="tog-fg"      aria-pressed="false" title="Furigana en JA">FG</button>
          <button class="btn" id="fs"          title="Pantalla completa">‚§¢</button>
        </div>
      </div>  
    </div> 
<!-- BLOQUE: Funciones destacadas -->
<section class="section" aria-labelledby="feat-title">
  <div class="frame">
    <div class="glass" style="padding:24px">
      <h2 id="feat-title" class="title" style="color:#7c3aed">Funciones destacadas</h2>

      <div class="functions-grid">
        <div class="card"><div class="card-inner">
          <div class="title">Subt√≠tulos multiling√ºes</div>
          <p class="muted">
            Altern√° al instante entre <strong>JA</strong> (japon√©s), <strong>RO</strong> (r≈çmaji), <strong>ES</strong> e <strong>EN</strong> sin recargar el video.
            Us√° los botones o los atajos <strong>J/A/E/N</strong> para cambiar r√°pido de pista.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">FG: Furigana</div>
          <p class="muted">
            Activ√° <strong>FG</strong> para mostrar la lectura solo sobre los <em>kanji</em> (no todo el texto), ideal para estudio.
            Funciona en la l√≠nea japonesa y respeta las partes que ya est√°n en kana. Atajo: <strong>G</strong>.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">Diccionario emergente</div>
          <p class="muted">
            Hac√© clic en una palabra (JA o RO) y aparece un panel con <strong>lectura</strong>, <strong>significado</strong> y <strong>nota de uso</strong>.
            El popover se posiciona cerca de la palabra y se cierra al hacer clic fuera.
          </p>
        </div></div>

        <div class="card"><div class="card-inner">
          <div class="title">Sincron√≠a JA ‚áÑ RO</div>
          <p class="muted">
            Al pasar el mouse o hacer clic, se resalta el segmento equivalente en r≈çmaji y en japon√©s.
            √ötil para detectar <em>frases hechas</em> y correspondencias reales, incluso en multi-palabra.
          </p>
        </div></div>
      </div>
    </div>
  </div>
</section>
</main>

  <!-- FOOTER -->
  <div class="footer">
    <div class="footer-inner">
      <div>
        <div class="title">Voces del Anime</div>
        <p>Prototipo conceptual con est√©tica pastel + glass.</p>
      </div>
      <div>
        <div class="title">Enlaces</div>
        <ul>
          <li><a href="contacto.html">Contacto</a></li>
          <li><a href="creditos.html">Cr√©ditos</a></li>
          <li><a href="politica.html">Pol√≠tica educativa</a></li>
        </ul>
      </div>
      <div>
        <div class="title">Acerca de</div>
        <p>Glosarios, cultura y comunidad listos para iterar.</p>
      </div>
    </div>
  </div>

<!-- === Script del reproductor === -->
<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const player=$('#player'), video=$('#video'), srcEl=$('#src');

  /* habilitar click en r≈çmaji */
  const roClickCSS = document.createElement('style');
  roClickCSS.textContent = '.track-romaji .word-ro{pointer-events:auto;cursor:pointer}';
  document.head.appendChild(roClickCSS);

  /* === üîß Estilo para subt√≠tulo EN (fix) === */
  const enStyle = document.createElement('style');
  enStyle.textContent = '.track-en{ background:rgba(216,180,254,.95); }';
  document.head.appendChild(enStyle);
  /* === fin fix === */

  const bigPlay=$('#bigPlay'), playBtn=$('#play'), iconPlay=$('#icon-play');
  const back10=$('#back10'), fwd10=$('#fwd10'), seek=$('#seek'),
        progressBar=$('#progressBar'), bufferedBar=$('#bufferedBar');
  const cur=$('#currentTime'), dur=$('#duration'), muteBtn=$('#mute'),
        vol=$('#volume'), speed=$('#speed'), fs=$('#fs'), badgeDur=$('#badgeDur');
  const diag=$('#diag'), statusSrc=$('#statusSrc');
  const pillJA=$('#pillJA'), pillRO=$('#pillRO'), pillES=$('#pillES'), pillEN=$('#pillEN');

  function log(msg){ diag.innerHTML = '['+new Date().toLocaleTimeString()+'] '+msg+'<br>'+diag.innerHTML; }
  function setSrc(url){ srcEl.src=url; statusSrc.textContent='src: '+url; video.load(); }

  function formatTime(s){
    if(!isFinite(s)) return '0:00';
    const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=String(Math.floor(s%60)).padStart(2,'0');
    return (h>0? h+':'+String(m).padStart(2,'0'):m)+':'+sec;
  }
  video.addEventListener('loadedmetadata',()=>{ dur.textContent=formatTime(video.duration); badgeDur.textContent=formatTime(video.duration); updateBuffered(); });

  function togglePlay(){ (video.paused||video.ended)?video.play():video.pause(); }
  ;[playBtn, video, bigPlay].forEach(el=>el.addEventListener('click', togglePlay));
  video.addEventListener('play', ()=>{ iconPlay.textContent='‚è∏'; bigPlay.style.display='none'; });
  video.addEventListener('pause', ()=>{ iconPlay.textContent='‚ñ∂';  bigPlay.style.display='grid'; });
function placePopoverAtSpan(span){
  const rect = span.getBoundingClientRect();
  const vw = window.innerWidth, vh = window.innerHeight;
  const margin = 8;

  // mostrar y medir
  pop.style.visibility = 'hidden';
  pop.style.display = 'block';
  const pr = pop.getBoundingClientRect();

  // preferir arriba; si no entra, abajo
  let top = rect.top - pr.height - 12;
  if (top < margin) top = rect.bottom + 12;

  // centrar en X y limitar a viewport
  let left = rect.left + (rect.width - pr.width)/2;
  left = Math.max(margin, Math.min(left, vw - pr.width - margin));
  top  = Math.max(margin, Math.min(top , vh - pr.height - margin));

  pop.style.left = left + 'px';
  pop.style.top  = top  + 'px';
  pop.style.visibility = 'visible';
}
  back10.addEventListener('click', ()=> video.currentTime=Math.max(0, (video.currentTime||0)-10));
  fwd10 .addEventListener('click', ()=> video.currentTime=Math.min(video.duration||0, (video.currentTime||0)+10));

  function updateTime(){
    cur.textContent=formatTime(video.currentTime);
    progressBar.style.width=((video.currentTime/(video.duration||1))*100)+'%';
    seek.value=Math.round((video.currentTime/(video.duration||1))*1000)||0;
  }
  function updateBuffered(){
    try{
      if(video.buffered && video.buffered.length){
        const end=video.buffered.end(video.buffered.length-1);
        bufferedBar.style.width=((end/(video.duration||1))*100)+'%';
      }
    }catch(e){}
  }
  video.addEventListener('timeupdate', updateTime);
  video.addEventListener('progress', updateBuffered);
  video.addEventListener('loadeddata', updateBuffered);
  seek.addEventListener('input', ()=>{ video.currentTime=(seek.value/1000)*(video.duration||0); updateTime(); });

  function updateMuteIcon(){
    const level=video.muted||video.volume===0?0:video.volume;
    muteBtn.textContent= level===0?'üîá':(level<.5?'üîà':'üîä');
  }
  vol.addEventListener('input', ()=>{ video.volume=Number(vol.value); if(video.volume>0) video.muted=false; updateMuteIcon(); });
  muteBtn.addEventListener('click', ()=>{ video.muted=!video.muted; updateMuteIcon(); });
  video.addEventListener('volumechange', updateMuteIcon); updateMuteIcon();

  speed.addEventListener('change', ()=>{ video.playbackRate=Number(speed.value); });
  function toggleFS(){ if(document.fullscreenElement) document.exitFullscreen(); else player.requestFullscreen().catch(()=>{}); }
  fs.addEventListener('click', toggleFS);

  const capJA=$('#cap-ja'), capRO=$('#cap-romaji'), capES=$('#cap-es'), capEN=$('#cap-en');
  const trkJA=$('#trk-ja'), trkRO=$('#trk-ro'), trkES=$('#trk-es'), trkEN=$('#trk-en');
  const togJA=$('#tog-ja'), togRO=$('#tog-romaji'), togES=$('#tog-es'), togEN=$('#tog-en'), togFG=$('#tog-fg');

  const tracks={ ja:trkJA?.track || null, ro:trkRO?.track || null, es:trkES?.track || null, en:trkEN?.track || null };
  Object.values(tracks).forEach(t=>{ if(t){ try{ t.mode='hidden'; }catch(_){} } });

  function armTrack(el, name, pill){
    if(!el){ if(pill) pill.textContent = name.toUpperCase()+': ‚Äî'; return; }
    const t = el.track;
    function ok(){ if(pill) pill.textContent = `${name.toUpperCase()}: ok (${t.cues?t.cues.length:0})`; renderCue(); }
    function err(){ if(pill) pill.textContent = `${name.toUpperCase()}: error`; }
    if (el.readyState === 2) ok(); else { el.addEventListener('load', ok, {once:true}); el.addEventListener('error', err, {once:true}); }
  }
  armTrack(trkJA,'ja',pillJA); armTrack(trkRO,'ro',pillRO); armTrack(trkES,'es',pillES); armTrack(trkEN,'en',pillEN);

  const state={ showJA:true, showRO:false, showES:false, showEN:false, showFG:false };
  const setToggle=(btn,on)=>btn && btn.setAttribute('aria-pressed', on);
  function syncToggles(){ setToggle(togJA,state.showJA); setToggle(togRO,state.showRO); setToggle(togES,state.showES); setToggle(togEN,state.showEN); setToggle(togFG,state.showFG); }
  function rerenderAndClean(){ renderCue(); clearJAHighlight(); clearROHighlight(); }
  syncToggles();
  togJA && togJA.addEventListener('click', ()=>{ state.showJA=!state.showJA; syncToggles(); rerenderAndClean(); });
  togRO && togRO.addEventListener('click', ()=>{ state.showRO=!state.showRO; syncToggles(); rerenderAndClean(); });
  togES && togES.addEventListener('click', ()=>{ state.showES=!state.showES; syncToggles(); rerenderAndClean(); });
  togEN && togEN.addEventListener('click', ()=>{ state.showEN=!state.showEN; syncToggles(); rerenderAndClean(); });
  togFG && togFG.addEventListener('click', ()=>{ state.showFG=!state.showFG; syncToggles(); renderCue(); });

  /* ======== Diccionario ======== */
  const JA_DICT={
    "Â≠´ÊÇüÈ£Ø":{yomi:"„Åù„Çì„Åî„ÅØ„Çì",gloss:"Son Gohan (nombre propio)",ro:"son gohan"},
    "Ê≠£„Åó„ÅÑ":{yomi:"„Åü„Å†„Åó„ÅÑ",gloss:"correcto; justo",ro:"tadashii"},
    "„Åì„Å®":{yomi:"„Åì„Å®",gloss:"cosa; hecho",ro:"koto"},
    "„Åü„ÇÅ„Å´":{yomi:"„Åü„ÇÅ„Å´",gloss:"para; por el bien de",ro:"tame ni"},
    "Êà¶„ÅÜ":{yomi:"„Åü„Åü„Åã„ÅÜ",gloss:"pelear; luchar",ro:"tatakau"},
    "ÁΩ™":{yomi:"„Å§„Åø",gloss:"pecado; culpa",ro:"tsumi"},
    "„Åß„ÅØ„Å™„ÅÑ":{yomi:"„Åß„ÅØ„Å™„ÅÑ",gloss:"no es; no ser (neg. de „Å†)",ro:"de wa nai"},
    "Ë©±„ÅóÂêà„ÅÑ":{yomi:"„ÅØ„Å™„Åó„ÅÇ„ÅÑ",gloss:"di√°logo; discusi√≥n",ro:"hanashiai"},
    "„Å™„Å©":{yomi:"„Å™„Å©",gloss:"etc.; cosas como ~",ro:"nado"},
    "ÈÄöÁî®„Åó„Å™„ÅÑ":{yomi:"„Å§„ÅÜ„Çà„ÅÜ„Åó„Å™„ÅÑ",gloss:"no funciona; no surte efecto",ro:"ts≈´y≈ç shinai"},
    "Áõ∏Êâã":{yomi:"„ÅÇ„ÅÑ„Å¶",gloss:"oponente; interlocutor",ro:"aite"},
    "„ÇÇ„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÇÇ„ÅÑ„Çã„ÅÆ„Å†",gloss:"tambi√©n hay/existen (explicativo)",ro:"mo iru no da"},
    "„ÅÑ„Çã„ÅÆ„Å†":{yomi:"„ÅÑ„Çã„ÅÆ„Å†",gloss:"(alguien) est√°/hay (explicativo)",ro:"iru no da"},
    "Á≤æÁ•û":{yomi:"„Åõ„ÅÑ„Åó„Çì",gloss:"esp√≠ritu; mente",ro:"seishin"},
    "ÂÖâ":{yomi:"„Å≤„Åã„Çä",gloss:"luz",ro:"hikari"},
    "„Åæ„Åæ":{yomi:"„Åæ„Åæ",gloss:"tal cual; manteniendo el estado",ro:"mama",note:"X „ÅÆ„Åæ„Åæ = 'tal como X'."},
    "Ëá™Áî±„Å´":{yomi:"„Åò„ÇÜ„ÅÜ„Å´",gloss:"libremente",ro:"jiy≈´ ni"},
    "Ëß£Êîæ„Åó„Å¶„ÇÑ„Çå":{yomi:"„Åã„ÅÑ„Åª„ÅÜ„Åó„Å¶„ÇÑ„Çå",gloss:"lib√©ralo",ro:"kaih≈ç shite yare"},
    "Ê∞óÊåÅ„Å°":{yomi:"„Åç„ÇÇ„Å°",gloss:"sentimiento",ro:"kimochi"},
    "ÂàÜ„Åã„Çã":{yomi:"„Çè„Åã„Çã",gloss:"entender",ro:"wakaru"},
    "„ÇÇ„ÅÜ":{yomi:"„ÇÇ„ÅÜ",gloss:"ya; m√°s",ro:"m≈ç"},
    "ÊàëÊÖ¢„Åô„Çã":{yomi:"„Åå„Åæ„Çì„Åô„Çã",gloss:"aguantarse",ro:"gaman suru"},
    "„Åì„Å®„ÅØ„Å™„ÅÑ":{yomi:"„Åì„Å®„ÅØ„Å™„ÅÑ",gloss:"no hace falta",ro:"koto wa nai"},
    "„ÅÆ„Åå":{yomi:"„ÅÆ„Åå",gloss:"(nominalizador+„Åå)",ro:"no ga"},
    // part√≠culas
    "„Çí":{yomi:"„Çí",gloss:"objeto directo",ro:"wo"},
    "„ÅØ":{yomi:"„ÅØ",gloss:"tema/contraste",ro:"wa"},
    "„Åå":{yomi:"„Åå",gloss:"sujeto/√©nfasis",ro:"ga"},
    "„Å´":{yomi:"„Å´",gloss:"tiempo/destino",ro:"ni"},
    "„Åß":{yomi:"„Åß",gloss:"lugar/medio",ro:"de"},
    "„Å®":{yomi:"„Å®",gloss:"y/con/cita",ro:"to"},
    "„ÇÇ":{yomi:"„ÇÇ",gloss:"tambi√©n",ro:"mo"},
    "„ÅÆ":{yomi:"„ÅÆ",gloss:"posesivo/nominaliza",ro:"no"},
    "„Å∏":{yomi:"„Å∏",gloss:"hacia",ro:"e"},
    "„Åã„Çâ":{yomi:"„Åã„Çâ",gloss:"desde/porque",ro:"kara"},
    "„Åæ„Åß":{yomi:"„Åæ„Åß",gloss:"hasta",ro:"made"},
    "„Çà„Çä":{yomi:"„Çà„Çä",gloss:"comparativo",ro:"yori"}
  };
  const DICT_KEYS=Object.keys(JA_DICT).sort((a,b)=>b.length-a.length);

  // Segmentaci√≥n JA priorizando diccionario
  const segJA = (typeof Intl!=='undefined' && Intl.Segmenter)? new Intl.Segmenter('ja',{granularity:'word'}) : null;
  function sliceWithDict(line){
    const out=[]; let i=0;
    while(i<line.length){
      let m=null;
      for(const k of DICT_KEYS){ if(line.startsWith(k,i)){ m=k; break; } }
      if(m){ const e=JA_DICT[m]; out.push({text:m, dict:e, start:i, end:i+m.length}); i+=m.length; }
      else{ out.push({text:line[i], start:i, end:i+1}); i++; }
    }
    return out;
  }
  function segmentJapanese(line){
    const raw=sliceWithDict(line);
    if(!segJA){ return raw.map(p=> ({text:p.text, start:p.start, end:p.end, dict:p.dict||null})); }
    const out=[]; let buffer='', bStart=null;
    const flush=()=>{
      if(!buffer) return;
      let pos=0;
      for(const it of segJA.segment(buffer)){
        const seg=it.segment;
        const st=bStart + buffer.indexOf(seg,pos);
        const en=st+seg.length;
        pos = buffer.indexOf(seg,pos)+seg.length;
        out.push({text:seg, start:st, end:en, dict:null});
      }
      buffer=''; bStart=null;
    };
    for(const p of raw){
      if(p.dict){ flush(); out.push({text:p.text,start:p.start,end:p.end,dict:p.dict}); }
      else{ if(buffer===''){ buffer=p.text; bStart=p.start; } else buffer+=p.text; }
    }
    flush(); return out;
  }

  /* ======== Romaji helpers ======== */
  const ROMA_MAP = {
    '„Åç„ÇÉ':'kya','„Åç„ÇÖ':'kyu','„Åç„Çá':'kyo','„Åó„ÇÉ':'sha','„Åó„ÇÖ':'shu','„Åó„Çá':'sho','„Å°„ÇÉ':'cha','„Å°„ÇÖ':'chu','„Å°„Çá':'cho',
    '„Å´„ÇÉ':'nya','„Å´„ÇÖ':'nyu','„Å´„Çá':'nyo','„Å≤„ÇÉ':'hya','„Å≤„ÇÖ':'hyu','„Å≤„Çá':'hyo','„Åø„ÇÉ':'mya','„Åø„ÇÖ':'myu','„Åø„Çá':'myo',
    '„Çä„ÇÉ':'rya','„Çä„ÇÖ':'ryu','„Çä„Çá':'ryo','„Åé„ÇÉ':'gya','„Åé„ÇÖ':'gyu','„Åé„Çá':'gyo','„Åò„ÇÉ':'ja','„Åò„ÇÖ':'ju','„Åò„Çá':'jo',
    '„Å≥„ÇÉ':'bya','„Å≥„ÇÖ':'byu','„Å≥„Çá':'byo','„Å¥„ÇÉ':'pya','„Å¥„ÇÖ':'pyu','„Å¥„Çá':'pyo',
    '„ÅÇ':'a','„ÅÑ':'i','„ÅÜ':'u','„Åà':'e','„Åä':'o','„Åã':'ka','„Åç':'ki','„Åè':'ku','„Åë':'ke','„Åì':'ko',
    '„Åï':'sa','„Åó':'shi','„Åô':'su','„Åõ':'se','„Åù':'so','„Åü':'ta','„Å°':'chi','„Å§':'tsu','„Å¶':'te','„Å®':'to',
    '„Å™':'na','„Å´':'ni','„Å¨':'nu','„Å≠':'ne','„ÅÆ':'no','„ÅØ':'ha','„Å≤':'hi','„Åµ':'fu','„Å∏':'he','„Åª':'ho',
    '„Åæ':'ma','„Åø':'mi','„ÇÄ':'mu','„ÇÅ':'me','„ÇÇ':'mo','„ÇÑ':'ya','„ÇÜ':'yu','„Çà':'yo','„Çâ':'ra','„Çä':'ri','„Çã':'ru','„Çå':'re','„Çç':'ro',
    '„Çè':'wa','„Çí':'wo','„Çì':'n',
    '„Åå':'ga','„Åé':'gi','„Åê':'gu','„Åí':'ge','„Åî':'go','„Åñ':'za','„Åò':'ji','„Åö':'zu','„Åú':'ze','„Åû':'zo',
    '„Å†':'da','„Å¢':'ji','„Å•':'zu','„Åß':'de','„Å©':'do','„Å∞':'ba','„Å≥':'bi','„Å∂':'bu','„Åπ':'be','„Åº':'bo','„Å±':'pa','„Å¥':'pi','„Å∑':'pu','„Å∫':'pe','„ÅΩ':'po',
    '„ÅÅ':'a','„ÅÉ':'i','„ÅÖ':'u','„Åá':'e','„Åâ':'o','„ÇÉ':'ya','„ÇÖ':'yu','„Çá':'yo','„Å£':'','„Éº':''
  };
  function hiraToRoma(str){
    let out=''; for(let i=0;i<str.length;i++){
      const ch=str[i], next=str[i+1]||'';
      if(ch==='„Å£' && next){ const roma = ROMA_MAP[next] || ''; if(roma) out += roma[0]; continue; }
      const dig=str.slice(i,i+2);
      if(ROMA_MAP[dig]){ out+=ROMA_MAP[dig]; i++; continue; }
      out += ROMA_MAP[ch] || ch;
    }
    return out;
  }

  // normalizador macrones ‚Üí secuencias y limpieza
  const norm = (s)=>{
    if(!s) return '';
    const macPre = {'ƒÄ':'aa','ƒÅ':'aa','ƒ™':'ii','ƒ´':'ii','≈™':'uu','≈´':'uu','ƒí':'ee','ƒì':'ee','≈å':'ou','≈ç':'ou'};
    s = s.replace(/[ƒÄƒÅƒ™ƒ´≈™≈´ƒíƒì≈å≈ç]/g, ch => macPre[ch] || ch)
         .replace(/a\u0304/gi,'aa').replace(/i\u0304/gi,'ii')
         .replace(/u\u0304/gi,'uu').replace(/e\u0304/gi,'ee').replace(/o\u0304/gi,'ou');
    return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
  };

  const isKanji = ch => /[\u3400-\u9FFF]/.test(ch);
const isKana  = ch => /[\u3040-\u309F\u30A0-\u30FF„Éº]/.test(ch);
const kataToHira = s => s.replace(/[\u30A1-\u30F6]/g, c => String.fromCharCode(c.charCodeAt(0)-0x60));

function makeRubyKanjiOnly(surface, yomi){
  if(!surface || !yomi) return surface;
  const y = kataToHira(yomi);
  const chars = Array.from(surface);

  // anclamos las s√≠labas que ya vienen en la palabra (kana) dentro de la lectura:
  let p=0;
  const anchors=[]; // [{i: idxSurface, q: idxYomi, len}]
  for(let i=0;i<chars.length;i++){
    const ch = chars[i];
    if(isKana(ch)){
      const h = kataToHira(ch);
      const q = y.indexOf(h, p);
      if(q !== -1){ anchors.push({i, q, len:h.length}); p = q + h.length; }
    }
  }

  let lastY = 0, out = '';
  const findAnchorFrom = (idx) => anchors.find(a => a.i >= idx);

  for(let i=0;i<chars.length;){
    if(isKanji(chars[i])){
      // agrupamos kanji contiguos como un solo <ruby>
      let j=i; while(j<chars.length && isKanji(chars[j])) j++;
      const next = findAnchorFrom(j);
      const endY = next ? next.q : y.length;
      let read = y.slice(lastY, endY);
      const group = chars.slice(i, j).join('');
      out += `<ruby><rb>${group}</rb><rt>${read}</rt></ruby>`;
      lastY = endY;
      i = j;
    }else{
      out += chars[i];
      const a = anchors.find(a => a.i === i);
      if(a) lastY = Math.max(lastY, a.q + a.len);
      i++;
    }
  }
  return out;
}


  /* ======== Render ======== */
 function renderLine(track, el, mode){
  const show = (state.showJA && mode==='ja') ||
               (state.showRO && mode==='ro') ||
               (state.showES && mode==='es') ||
               (state.showEN && mode==='en');
  if(!show){ el.hidden=true; el.innerHTML=''; return; }

  // localizar cue activo
  let cue=null;
  if(track?.activeCues?.length) cue=track.activeCues[0];
  else if(track?.cues?.length){
    const t=video.currentTime;
    for(let i=0;i<track.cues.length;i++){
      const c=track.cues[i];
      if(t>=c.startTime && t<=c.endTime){ cue=c; break; }
    }
  }
  if(!cue){ el.hidden=true; el.innerHTML=''; return; }

  el.hidden=false; el.innerHTML='';
  const lines = cue.text.split(/\r?\n/);

  for(let li=0; li<lines.length; li++){
    const lineText = lines[li];

    if(mode==='ja'){
      const tokens = segmentJapanese(lineText);
      const wrap = document.createElement('span');
      wrap.className = 'line-ja';
      wrap.dataset.text = lineText;

      tokens.forEach((tok, idx) => {
        const sp = document.createElement('span');
        sp.className = 'word-ja';

        // ¬øeste token tiene kanji?
        const hasKanji = Array.from(tok.text).some(isKanji);

        // Furigana solo sobre los kanji si FG est√° activo y hay lectura en el diccionario
        if (state.showFG && tok.dict && hasKanji) {
          sp.innerHTML = makeRubyKanjiOnly(tok.text, tok.dict.yomi);
        } else {
          sp.textContent = tok.text;
        }

        // metadatos
        sp.dataset.word  = tok.text.trim();
        sp.dataset.start = tok.start;
        sp.dataset.end   = tok.end;
        sp.dataset.idx   = idx;

        if (tok.dict) {
          sp.dataset.dict  = '1';
          sp.dataset.yomi  = tok.dict.yomi  || '';
          sp.dataset.gloss = tok.dict.gloss || '';
          if (tok.dict.ro)   sp.dataset.roma = tok.dict.ro;
          if (tok.dict.note) sp.dataset.note = tok.dict.note;
        } else {
          sp.dataset.dict = '0';
        }

        wrap.appendChild(sp);
      });

      el.appendChild(wrap);

    } else if(mode==='ro'){
      const parts = lineText.split(/(\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-])/).filter(Boolean);
      let idx=0;
      parts.forEach(tok=>{
        if(/\s+|[.,!?¬°¬ø‚Ä¶:;()\[\]'"-]/.test(tok)){
          el.appendChild(document.createTextNode(tok));
        }else{
          const sp=document.createElement('span');
          sp.className='word-ro';
          sp.textContent=tok;
          sp.dataset.norm = norm(tok);
          sp.dataset.idx = String(idx++);
          el.appendChild(sp);
        }
      });

    } else {
      el.appendChild(document.createTextNode(lineText));
    }

    if(li<lines.length-1) el.appendChild(document.createElement('br'));
  }
}


  function renderCue(){
    renderLine(tracks.ja,capJA,'ja');
    renderLine(tracks.ro,capRO,'ro');
    renderLine(tracks.es,capES,'es');
    renderLine(tracks.en,capEN,'en');
  }
  Object.values(tracks).forEach(t=>{ t && t.addEventListener('cuechange', renderCue); });
  video.addEventListener('timeupdate', renderCue);
  video.addEventListener('seeked', renderCue);
  video.addEventListener('ratechange', renderCue);
  window.addEventListener('load', renderCue);

  /* ======== Popover + highlight ======== */
  const pop=$('#popover'), pvWord=$('#pv-word'), pvRead=$('#pv-read'), pvMeaning=$('#pv-meaning');

  function longestDictAt(line, pos){
    let best = null;
    for (const k of DICT_KEYS){
      let from = 0, i;
      while ((i = line.indexOf(k, from)) !== -1){
        const j = i + k.length;
        if (i <= pos && pos < j){
          if (!best || k.length > best.text.length){
            best = { text:k, start:i, end:j, entry: JA_DICT[k] };
          }
        }
        from = i + 1;
        if (from >= line.length) break;
      }
    }
    return best;
  }

  // helpers de highlight (una sola vez)
  let roBadgeEl=null;
  function clearROHighlight(){
    capRO.querySelectorAll('.hl').forEach(el=>el.classList.remove('hl'));
    if(roBadgeEl && roBadgeEl.parentNode) roBadgeEl.parentNode.removeChild(roBadgeEl);
    roBadgeEl=null;
  }
  function clearJAHighlight(){ capJA.querySelectorAll('.hl').forEach(el=>el.classList.remove('hl')); }

  // Resaltar en RO a partir de romaji
  function highlightInRO(romaji){
    clearROHighlight();
    if(!state.showRO || !romaji) return;
    const target = norm(romaji);
    const toks = Array.from(capRO.querySelectorAll('.word-ro'));
    const norms = toks.map(t=>t.dataset.norm||'');

    for(let i=0;i<norms.length;i++){
      let cat='';
      for(let j=i;j<norms.length;j++){
        cat += norms[j];
        if(cat===target){
          for(let k=i;k<=j;k++) toks[k].classList.add('hl');
          return;
        }
        if(cat.length >= target.length) break;
      }
    }
    for(let i=0;i<norms.length;i++){ if(norms[i]===target){ toks[i].classList.add('hl'); return; } }
    let pick=-1, bestLen=0;
    for(let i=0;i<norms.length;i++){
      const n=norms[i];
      if(n.includes(target) || target.includes(n)){ if(n.length>bestLen){ pick=i; bestLen=n.length; } }
    }
    if(pick!==-1){ toks[pick].classList.add('hl'); return; }
    roBadgeEl=document.createElement('span'); roBadgeEl.className='ro-badge'; roBadgeEl.textContent=romaji; capRO.appendChild(roBadgeEl);
  }

  /* === HOVER: Japon√©s -> Romaji (si ambos visibles) === */
  capJA.addEventListener('mousemove', (e) => {
    if (!state.showJA) return;

    const jaSpan = e.target.closest('.word-ja');
    clearJAHighlight();

    if (!jaSpan) {
      if (state.showRO) clearROHighlight();
      return;
    }

    jaSpan.classList.add('hl');

    if (!state.showRO) return;

    let romaji = jaSpan.dataset.roma || '';
    let yomi   = jaSpan.dataset.yomi || '';
    const txt  = jaSpan.textContent || '';

    if (!yomi && /[\u3040-\u309F]/.test(txt)) yomi = txt;
    if (!romaji && yomi) romaji = hiraToRoma(yomi);

    if (romaji) highlightInRO(romaji); else clearROHighlight();
  });

  capJA.addEventListener('mouseleave', () => {
    clearJAHighlight();
    if (state.showRO) clearROHighlight();
  });

  /* === HOVER: Romaji -> Japon√©s (si JA visible) === */
  capRO.addEventListener('mousemove', (e)=>{
    if(!state.showRO) return;

    const roSpan = e.target.closest('.word-ro');
    clearROHighlight();

    if(!roSpan){
      if(state.showJA) clearJAHighlight();
      return;
    }

    roSpan.classList.add('hl');

    if(!state.showJA) return;

    const toks = Array.from(capRO.querySelectorAll('.word-ro'));
    const idx  = toks.indexOf(roSpan);
    const get  = i => (i>=0 && i<toks.length)? toks[i].textContent.trim() : null;

    let match=null, entry=null, key=null, win=null;
    outer:
    for (let w=4; w>=1; w--) {
      for (let start=idx-(w-1); start<=idx; start++) {
        if (start<0) continue;
        const parts=[];
        for (let k=0;k<w;k++){ const t=get(start+k); if(!t){ parts.length=0; break; } parts.push(t); }
        if(!parts.length) continue;
        const cand = parts.join(' ');
        for (const k of DICT_KEYS) {
          const e = JA_DICT[k]; if(!e || !e.ro) continue;
          if (norm(e.ro) === norm(cand)) { match=cand; entry=e; key=k; win={start, end:start+w-1}; break outer; }
        }
      }
    }

    if(match){
      for (let i=win.start; i<=win.end; i++) toks[i].classList.add('hl');

      clearJAHighlight();
      let found=false;
      capJA.querySelectorAll('.word-ja').forEach(sp=>{
        if(sp.dataset.word===key){ sp.classList.add('hl'); found=true; }
      });
      if(!found){
        const wrap=capJA.querySelector('.line-ja');
        const line=wrap?(wrap.dataset.text||''):''; const pos=line.indexOf(key);
        if(pos>=0){
          capJA.querySelectorAll('.word-ja').forEach(sp=>{
            const s=Number(sp.dataset.start)||0, en=Number(sp.dataset.end)||0;
            if(s<pos+key.length && en>pos) sp.classList.add('hl');
          });
        } else {
          const byRo = norm(entry.ro);
          capJA.querySelectorAll('.word-ja').forEach(sp=>{
            const r = sp.dataset.roma || (sp.dataset.yomi ? hiraToRoma(sp.dataset.yomi) : '');
            if (r && norm(r) && byRo.includes(norm(r))) sp.classList.add('hl');
          });
        }
      }
    }
  });

  capRO.addEventListener('mouseleave', ()=>{
    clearROHighlight();
    if(state.showJA) clearJAHighlight();
  });

  /* === CLICK EN JAPO: popover + sincroniza RO === */
  document.addEventListener('click',(e)=>{
    if(!state.showJA) return;
    if(!capJA.contains(e.target)) { if(!e.target.closest('#popover')) pop.style.display='none'; return; }

    const span=e.target.closest('.word-ja'); if(!span) return;
    const lineWrap=span.closest('.line-ja');
    const lineText=lineWrap?lineWrap.dataset.text||'':'';
    const start=Number(span.dataset.start)||0, end=Number(span.dataset.end)||start+(span.textContent||'').length;
    const pos=Math.floor((start+end)/2);

    let surface = span.dataset.word || span.textContent;
    let entry = (span.dataset.dict==='1') ? {yomi:span.dataset.yomi,gloss:span.dataset.gloss,ro:span.dataset.roma,note:span.dataset.note} : null;

    if(!entry){
      const best=longestDictAt(lineText, pos);
      if(best){ surface=best.text; entry={yomi:best.entry.yomi,gloss:best.entry.gloss,ro:best.entry.ro,note:best.entry.note}; }
    }

    pvWord.textContent = surface;
    pvRead.textContent = 'Lectura: ' + (entry?.yomi || '‚Äî');
    pvMeaning.textContent = 'Significado: ' + (entry?.gloss || '‚Äî') + (entry?.note ? ' ¬∑ Uso: ' + entry.note : '');

  pop.style.display='block';
requestAnimationFrame(()=> placePopoverAtSpan(span));

    const romaOut = entry?.ro || (entry?.yomi ? hiraToRoma(entry.yomi) : '');
    if(romaOut) highlightInRO(romaOut);
  }, true);

/* === CLICK EN ROMAJI: popover + reflejo JA === */
document.addEventListener('click',(e)=>{
  if(!state.showRO) return;
  if(!capRO.contains(e.target)) return;
  const roSpan = e.target.closest('.word-ro'); if(!roSpan) return;

  const toks = Array.from(capRO.querySelectorAll('.word-ro'));
  const idx  = toks.indexOf(roSpan);
  const get  = i => (i>=0 && i<toks.length)? toks[i].textContent.trim() : null;

  // candidatos de 1 a 4 tokens alrededor del clic
  const candidates = [];
  for (let w=4; w>=1; w--) {
    for (let start=idx-(w-1); start<=idx; start++) {
      if (start<0) continue;
      const parts=[];
      for (let k=0;k<w;k++){ const t=get(start+k); if(!t){ parts.length=0; break; } parts.push(t); }
      if(parts.length) candidates.push({start, end:start+w-1, text:parts.join(' ')});
    }
  }

  // encontrar el candidato que coincide con el diccionario (por r≈çmaji normalizado)
  let match=null, entry=null, key=null;
  const keysWithRO = DICT_KEYS.filter(k => JA_DICT[k]?.ro);
  for (const cand of candidates) {
    const cn = norm(cand.text);
    for (const k of keysWithRO) {
      if (norm(JA_DICT[k].ro) === cn) { match=cand; entry=JA_DICT[k]; key=k; break; }
    }
    if (match) break;
  }
  if(!entry || !match) return;

  // llenar popover
  pvWord.textContent = key;
  pvRead.textContent = 'Lectura: ' + (entry.yomi || '‚Äî');
  pvMeaning.textContent = 'Significado: ' + (entry.gloss || '‚Äî') + (entry.note ? ' ¬∑ Uso: ' + entry.note : '');

  // mostrar popover bien posicionado (usa position:fixed en CSS)
  pop.style.display='block';
  requestAnimationFrame(()=> placePopoverAtSpan(roSpan));

  // highlight correcto en RO
  clearROHighlight();
  for (let i = match.start; i <= match.end; i++) toks[i].classList.add('hl');

  // reflejo en JA si est√° visible
  if (state.showJA) {
    clearJAHighlight();
    const spans = Array.from(capJA.querySelectorAll('.word-ja'));
    const wrap = capJA.querySelector('.line-ja');
    const lineText = wrap ? (wrap.dataset.text || '') : '';
    let jStart = lineText.indexOf(key);
    if (jStart >= 0) {
      spans.forEach(sp=>{
        const s = Number(sp.dataset.start)||0, e2 = Number(sp.dataset.end)||0;
        if (s < jStart + key.length && e2 > jStart) sp.classList.add('hl');
      });
    } else {
      const byRo = norm(entry.ro);
      spans.forEach(sp=>{
        const r = sp.dataset.roma || (sp.dataset.yomi ? hiraToRoma(sp.dataset.yomi) : '');
        if (r && norm(r) && byRo.includes(norm(r))) sp.classList.add('hl');
      });
    }
  }
});


  // limpieza global
  document.addEventListener('mouseleave', ()=>{ clearJAHighlight(); clearROHighlight(); }, true);

  // Herramientas y atajos
  $('#btnTest').addEventListener('click', ()=>{ setSrc('https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4'); log('Cargando video de prueba MDN'); });
  $('#btnURL').addEventListener('click', ()=>{ const u=prompt('Peg√° una URL directa a .mp4 (https://...)'); if(!u) return; setSrc(u.trim()); log('Cambi√© src a '+u); });
  document.addEventListener('keydown',(e)=>{ if(e.key==='j' || e.key==='J'){ togJA && togJA.click(); } if(e.key==='a' || e.key==='A'){ togRO && togRO.click(); } if(e.key==='e' || e.key==='E'){ togES && togES.click(); } if(e.key==='n' || e.key==='N'){ togEN && togEN.click(); } if(e.key==='g' || e.key==='G'){ togFG && togFG.click(); } });

  // inicial
  renderCue();
})();
</script>
</body>
</html>
